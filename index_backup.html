<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job OS - Your Career Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.12.2/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.12.2/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #818cf8; }
        .table-responsive, .kanban-board-wrapper {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .nav-tab {
            padding-bottom: 8px;
            border-bottom-width: 2px;
            border-color: transparent;
            transition: all 0.2s ease-in-out;
        }
        .nav-tab.active-tab {
            border-color: #6366f1; /* indigo-500 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .app-view.hidden, .job-view.hidden {
            display: none;
        }
        .metric-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .kanban-column {
            min-width: 300px;
            max-width: 300px;
        }
        .kanban-card {
            cursor: grab;
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        .kanban-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .drag-over {
            background-color: #e0e7ff; /* indigo-100 */
            border-color: #818cf8;
        }
        
        /* Task Management Styles */
        .task-item {
            transition: all 0.2s ease-in-out;
        }
        
        .task-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .task-item .task-complete-btn:hover {
            background-color: #dcfce7;
            border-radius: 4px;
        }
        
        .task-item .task-edit-btn:hover,
        .task-item .task-delete-btn:hover {
            background-color: #f3f4f6;
            border-radius: 4px;
        }
        
        /* Task Priority Animations */
        .task-item.priority-high {
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { border-left-color: #ef4444; }
            50% { border-left-color: #fca5a5; }
        }
        
        /* Smart To-Do List Container */
        #tasks-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #tasks-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #tasks-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #tasks-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Smart Resume Styles */
        .smart-resume-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .resume-input-area {
            transition: all 0.3s ease;
        }
        
        .resume-input-area:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Interview Prep Styles */
        .question-card {
            transition: all 0.3s ease;
            border-left: 4px solid #6366f1;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .difficulty-easy { border-left-color: #10b981; }
        .difficulty-medium { border-left-color: #f59e0b; }
        .difficulty-hard { border-left-color: #ef4444; }
        
        .practice-mode {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-processing-animation {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .resume-output-container {
            font-family: 'Courier New', 'Monaco', monospace;
            line-height: 1.6;
        }
        
        .generate-button-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .generate-button-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Enhanced Resume Formatting */
        .formatted-resume {
            line-height: 1.7;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .formatted-resume h1 {
            color: #1f2937;
            border-bottom: 3px solid #6366f1;
            padding-bottom: 0.5rem;
        }
        
        .formatted-resume h3 {
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .formatted-resume h4 {
            color: #4b5563;
        }
        
        .formatted-resume li {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        
        .resume-input-option {
            transition: all 0.3s ease;
        }
        
        /* Calendar Integration Styles */
        .calendar-event-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-left: 0.5rem;
        }
        
        .interview-upcoming {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse-interview 2s infinite;
        }
        
        @keyframes pulse-interview {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .calendar-integration-success {
            background: #10b981;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        
        .calendar-integration-error {
            background: #ef4444;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Main Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                         <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <h1 class="text-2xl font-bold text-gray-800 ml-3">Job OS</h1>
                    </div>
                    <div id="auth-status" class="text-xs text-gray-500 font-mono text-right">Connecting...</div>
                </div>
            </div>
             <!-- Navigation -->
            <nav class="bg-white border-t border-gray-200">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center space-x-8">
                        <button class="nav-tab active-tab" data-tab="dashboard">Dashboard</button>
                        <button class="nav-tab" data-tab="jobs">Job Tracker</button>
                        <button class="nav-tab" data-tab="smart-resume">Smart Resume</button>
                        <button class="nav-tab" data-tab="interview-prep">Interview Prep</button>
                        <button class="nav-tab" data-tab="cover-letter">Cover Letter</button>
                        <button class="nav-tab" data-tab="network">Network Manager</button>
                        <button class="nav-tab" data-tab="history">Work History</button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
             <!-- Dashboard View -->
            <div id="dashboard-view" class="app-view">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Dashboard</h2>
                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Applications -->
                    <div class="metric-card bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div class="bg-indigo-100 p-3 rounded-full">
                           <svg class="w-6 h-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.789-2.75 9.566l-2.75-2.75a2 2 0 010-2.828l2.75-2.75A2 2 0 0112 11zm0 0a2 2 0 012 2v3.172a2 2 0 00.586 1.414l2.75 2.75c.781.781.781 2.047 0 2.828l-2.75 2.75a2 2 0 01-2.828 0l-2.75-2.75a2 2 0 010-2.828l2.75-2.75A2 2 0 0112 11zm0 0V4a2 2 0 012-2h1a2 2 0 012 2v1" /></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500">Total Applications</p>
                            <p id="metric-apps" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                     <!-- Interviews -->
                    <div class="metric-card bg-white p-6 rounded-xl shadow-lg flex items-center">
                         <div class="bg-blue-100 p-3 rounded-full">
                           <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500">Interviews</p>
                            <p id="metric-interviews" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                     <!-- Offers -->
                    <div class="metric-card bg-white p-6 rounded-xl shadow-lg flex items-center">
                         <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500">Offers</p>
                            <p id="metric-offers" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                     <!-- Contacts -->
                    <div class="metric-card bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full">
                           <svg class="w-6 h-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500">Active Contacts</p>
                            <p id="metric-contacts" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>
                <!-- Tasks and Analytics Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Intelligent To-Do List -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-700">Smart To-Do List</h3>
                            <button id="add-task-btn" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Task
                            </button>
                        </div>
                        <div id="tasks-container" class="space-y-3 max-h-80 overflow-y-auto">
                            <div id="no-tasks" class="text-center text-gray-500 py-8">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <p>No tasks yet. Add some applications to get started!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Funnel Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Application Funnel</h3>
                        <div class="h-80">
                            <canvas id="funnel-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Tracker View -->
            <div id="jobs-view" class="app-view hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-semibold text-gray-700">Job Application Tracker</h2>
                     <div class="flex items-center gap-4">
                        <!-- View Toggler -->
                        <div class="bg-gray-200 p-1 rounded-lg flex items-center">
                            <button id="view-table-btn" class="px-3 py-1 text-sm font-semibold rounded-md bg-white text-indigo-600 shadow">Table</button>
                            <button id="view-board-btn" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">Board</button>
                        </div>
                        <button id="add-job-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                            <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Application
                        </button>
                    </div>
                </div>
                <!-- Table View -->
                <div id="jobs-table-view" class="job-view bg-white p-6 rounded-xl shadow-lg">
                    <div id="jobs-table-container" class="table-responsive">
                       <p id="jobs-loading-state" class="text-center text-gray-500 py-8">Loading job applications...</p>
                    </div>
                </div>
                <!-- Kanban Board View -->
                <div id="jobs-board-view" class="job-view hidden">
                    <div id="jobs-board-container" class="kanban-board-wrapper">
                        <div id="kanban-board" class="flex space-x-4 pb-4">
                            <!-- Columns will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Manager View -->
            <div id="network-view" class="app-view hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-semibold text-gray-700">Network & Recruiters</h2>
                    <button id="add-contact-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Contact
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div id="network-table-container" class="table-responsive">
                       <p id="loading-state" class="text-center text-gray-500 py-8">Loading contacts...</p>
                    </div>
                </div>
            </div>
            <!-- Work History View -->
            <div id="history-view" class="app-view hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-semibold text-gray-700">Work History</h2>
                    <button id="add-history-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Job
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div id="history-table-container" class="table-responsive">
                       <p id="history-loading-state" class="text-center text-gray-500 py-8">Loading work history...</p>
                    </div>
                </div>
            </div>

            <!-- Smart Resume View -->
            <div id="smart-resume-view" class="app-view hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">AI-Powered Resume Tailoring</h2>
                        <p class="text-gray-600 text-lg">Transform your resume in seconds with AI that understands what employers want</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Input Section -->
                        <div class="space-y-6">
                            <!-- Job Description Input -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4">
                                    <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Job Description</h3>
                                </div>
                                <textarea id="job-description-input" 
                                    class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" 
                                    placeholder="Paste the full job description here...

Example:
We are looking for a Senior Software Engineer to join our team. The ideal candidate will have:
- 5+ years of experience with Python and Django
- Strong knowledge of React and modern frontend frameworks
- Experience with AWS cloud services
- Bachelor's degree in Computer Science or related field
..."></textarea>
                                <div class="mt-2 text-xs text-gray-500">
                                    💡 Tip: Include the full job posting for best results
                                </div>
                            </div>
                            
                            <!-- Current Resume Input -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4">
                                    <div class="bg-green-100 p-2 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Your Current Resume</h3>
                                </div>
                                
                                <!-- Resume Input Options -->
                                <div class="mb-4">
                                    <div class="flex items-center space-x-4 mb-3">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="resume-input-type" value="upload" class="text-indigo-600 focus:ring-indigo-500" checked>
                                            <span class="ml-2 text-sm font-medium text-gray-700">Upload PDF Resume</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="resume-input-type" value="text" class="text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-sm font-medium text-gray-700">Paste Text</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- PDF Upload Section -->
                                <div id="resume-upload-section" class="resume-input-option">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
                                        <input type="file" id="resume-pdf-input" accept=".pdf" class="hidden">
                                        <div id="upload-area" class="cursor-pointer" onclick="document.getElementById('resume-pdf-input').click()">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            <p class="mt-2 text-sm text-gray-600">
                                                <span class="font-medium text-indigo-600">Click to upload</span> or drag and drop
                                            </p>
                                            <p class="text-xs text-gray-500">PDF files only (Max 10MB)</p>
                                        </div>
                                        <div id="uploaded-file-info" class="hidden mt-3 p-3 bg-green-50 rounded-lg">
                                            <div class="flex items-center">
                                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span id="file-name" class="text-sm font-medium text-green-800"></span>
                                                <button type="button" onclick="window.clearUploadedFile()" class="ml-auto text-green-600 hover:text-green-800">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Text Input Section -->
                                <div id="resume-text-section" class="resume-input-option hidden">
                                    <textarea id="current-resume-input" 
                                        class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" 
                                        placeholder="Paste your current resume text here...

Example:
John Smith
Software Engineer
email@example.com | (555) 123-4567

EXPERIENCE
Software Developer at TechCorp (2020-2023)
- Developed web applications using Python and React
- Collaborated with cross-functional teams
..."></textarea>
                                </div>
                                
                                <div class="mt-2 text-xs text-gray-500">
                                    💡 Tip: PDF upload is recommended for best formatting results
                                </div>
                            </div>
                        </div>
                        
                        <!-- Results Section -->
                        <div class="space-y-6">
                            <!-- AI Processing Section -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="text-center">
                                    <div class="bg-indigo-100 p-3 rounded-lg inline-block mb-4">
                                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">AI Resume Optimizer</h3>
                                    <p class="text-gray-600 mb-6">Our AI analyzes job requirements and optimizes your resume for maximum impact</p>
                                    
                                    <button id="generate-resume-btn" 
                                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:from-indigo-700 hover:to-purple-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                        <span id="generate-btn-text">Generate Tailored Resume</span>
                                        <svg id="generate-btn-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </button>
                                    
                                    <div class="mt-4 text-sm text-gray-500">
                                        <div class="flex items-center justify-center space-x-4">
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                                Keyword Optimization
                                            </div>
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                                Skills Highlighting
                                            </div>
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                                                ATS-Friendly Format
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Results Display -->
                            <div id="results-container" class="bg-white p-6 rounded-xl shadow-lg hidden">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="bg-green-100 p-2 rounded-lg mr-3">
                                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Tailored Resume</h3>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="copy-resume-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center text-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            Copy
                                        </button>
                                        <button id="download-resume-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center text-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>
                                <div id="tailored-resume-output" class="bg-gray-50 p-6 rounded-lg border border-gray-200 h-96 overflow-y-auto resume-output-container">
                                    <div class="prose prose-sm max-w-none">
                                        <!-- Formatted resume content will appear here -->
                                    </div>
                                </div>
                                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="text-blue-800 text-sm">
                                            <p class="font-semibold mb-1">Next Steps:</p>
                                            <ul class="list-disc list-inside space-y-1 text-blue-700">
                                                <li>Review the tailored content and make any personal adjustments</li>
                                                <li>Format the text in your preferred resume template</li>
                                                <li>Proofread for accuracy and personal touch</li>
                                                <li>Save this version specifically for this application</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tips Section -->
                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
                                <h4 class="font-semibold text-yellow-800 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                    Pro Tips for Best Results
                                </h4>
                                <ul class="text-yellow-700 text-sm space-y-2">
                                    <li class="flex items-start">
                                        <span class="text-yellow-500 mr-2">•</span>
                                        Include the complete job description with all requirements and preferred qualifications
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-yellow-500 mr-2">•</span>
                                        Use your most recent and comprehensive resume as the input
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-yellow-500 mr-2">•</span>
                                        Review the AI-generated content and add your personal touch
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-yellow-500 mr-2">•</span>
                                        Generate a new tailored version for each unique job application
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interview Prep View -->
            <div id="interview-prep-view" class="app-view hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="mb-8">
                        <div class="text-center mb-6">
                            <h1 class="text-4xl font-bold text-gray-900 mb-3">🎯 AI Interview Coach</h1>
                            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                                Get personalized interview questions and practice sessions tailored to your specific job applications
                            </p>
                        </div>
                        
                        <!-- Job Selection -->
                        <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                            <div class="flex items-center mb-4">
                                <div class="bg-indigo-100 p-2 rounded-lg mr-3">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2V6"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Select Job Application</h3>
                            </div>
                            
                            <select id="interview-job-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select a job application for interview prep...</option>
                            </select>
                            
                            <div id="selected-job-info" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h4 id="selected-job-title" class="font-semibold text-gray-900"></h4>
                                        <p id="selected-job-company" class="text-gray-600"></p>
                                        <span id="selected-job-status" class="inline-block px-2 py-1 text-xs rounded-full mt-2"></span>
                                    </div>
                                    <button id="generate-questions-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Generate Questions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Content Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Questions Panel -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800">Interview Questions</h3>
                                    <div class="flex items-center space-x-2">
                                        <button id="filter-all" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
                                            Show All
                                        </button>
                                        <button id="filter-behavioral" class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition">
                                            Behavioral
                                        </button>
                                        <button id="filter-technical" class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition">
                                            Technical
                                        </button>
                                        <button id="filter-company" class="px-3 py-1 text-sm rounded-full bg-purple-100 text-purple-700 hover:bg-purple-200 transition">
                                            Company
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="questions-container" class="space-y-4">
                                    <div class="text-center py-12 text-gray-500">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="text-lg font-medium">No questions generated yet</p>
                                        <p class="text-sm">Select a job application and click "Generate Questions" to get started</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Practice Panel -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-6">Practice Session</h3>
                                
                                <div id="practice-container" class="hidden">
                                    <div class="mb-4">
                                        <h4 id="practice-question" class="font-medium text-gray-900 mb-3"></h4>
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Answer:</label>
                                            <textarea id="practice-answer" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your answer here..."></textarea>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button id="get-feedback-btn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                                                Get AI Feedback
                                            </button>
                                            <button id="next-question-btn" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                                                Next Question
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="feedback-container" class="hidden mt-4 p-4 bg-green-50 rounded-lg">
                                        <h5 class="font-medium text-green-800 mb-2">AI Feedback:</h5>
                                        <div id="feedback-content" class="text-green-700 text-sm"></div>
                                    </div>
                                </div>
                                
                                <div id="practice-placeholder" class="text-center py-8 text-gray-500">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p class="font-medium">Practice Mode</p>
                                    <p class="text-sm">Click on any question to start practicing</p>
                                </div>
                            </div>
                            
                            <!-- Quick Tips -->
                            <div class="mt-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6">
                                <h4 class="font-semibold text-gray-800 mb-3">💡 Interview Tips</h4>
                                <ul class="text-sm text-gray-600 space-y-2">
                                    <li>• Use the STAR method (Situation, Task, Action, Result)</li>
                                    <li>• Prepare specific examples from your experience</li>
                                    <li>• Practice out loud, not just in your head</li>
                                    <li>• Research the company culture and values</li>
                                    <li>• Prepare thoughtful questions to ask them</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cover Letter Generator View -->
            <div id="cover-letter-view" class="app-view hidden">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-900 mb-3">✍️ AI Cover Letter Generator</h1>
                        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                            Create compelling, personalized cover letters by uploading your resume and entering job details
                        </p>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Input Section -->
                        <div class="space-y-6">
                            <!-- Resume Upload Section -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4">
                                    <div class="bg-green-100 p-2 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Upload Your Resume</h3>
                                </div>
                                
                                <!-- Resume Input Options -->
                                <div class="mb-4">
                                    <div class="flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="cover-resume-input-type" value="upload" class="text-green-600 focus:ring-green-500" checked>
                                            <span class="ml-2 text-sm font-medium text-gray-700">Upload PDF</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="cover-resume-input-type" value="text" class="text-green-600 focus:ring-green-500">
                                            <span class="ml-2 text-sm font-medium text-gray-700">Paste Text</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- PDF Upload Section -->
                                <div id="cover-resume-upload-section" class="cover-resume-input-option">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors">
                                        <input type="file" id="cover-resume-pdf-input" accept=".pdf" class="hidden">
                                        <div id="cover-upload-area" class="cursor-pointer" onclick="document.getElementById('cover-resume-pdf-input').click()">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <p class="mt-2 text-sm text-gray-600">Click to upload your resume PDF</p>
                                            <p class="text-xs text-gray-500">PDF files up to 10MB</p>
                                        </div>
                                        
                                        <!-- File Info Display -->
                                        <div id="cover-uploaded-file-info" class="hidden mt-4 p-3 bg-green-50 rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <span id="cover-file-name" class="text-sm font-medium text-green-800"></span>
                                                </div>
                                                <button onclick="clearCoverUploadedFile()" class="text-red-600 hover:text-red-800">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Text Input Section -->
                                <div id="cover-resume-text-section" class="cover-resume-input-option hidden">
                                    <textarea id="cover-current-resume-input" 
                                        class="w-full h-32 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none text-sm" 
                                        placeholder="Paste your resume text here..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Job Details Section -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4">
                                    <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2V6"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Job Details</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Job Title</label>
                                            <input type="text" id="cover-job-title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Data Scientist">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                            <input type="text" id="cover-company-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Microsoft">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                                        <textarea id="cover-job-description" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none text-sm" placeholder="Paste the job description here..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Cover Letter Options -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4">
                                    <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">Customization Options</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Writing Tone</label>
                                        <select id="cover-letter-tone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                            <option value="professional">Professional</option>
                                            <option value="enthusiastic">Enthusiastic</option>
                                            <option value="confident">Confident</option>
                                            <option value="conversational">Conversational</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Letter Length</label>
                                        <select id="cover-letter-length" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                            <option value="concise">Concise (2-3 paragraphs)</option>
                                            <option value="standard">Standard (3-4 paragraphs)</option>
                                            <option value="detailed">Detailed (4-5 paragraphs)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Focus Areas</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="focus-experience" class="mr-2 text-purple-600 focus:ring-purple-500" checked>
                                                <span class="text-sm">Experience</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="focus-skills" class="mr-2 text-purple-600 focus:ring-purple-500" checked>
                                                <span class="text-sm">Skills</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="focus-passion" class="mr-2 text-purple-600 focus:ring-purple-500">
                                                <span class="text-sm">Passion</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="focus-achievements" class="mr-2 text-purple-600 focus:ring-purple-500">
                                                <span class="text-sm">Achievements</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="generate-cover-letter-btn" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-purple-700 hover:to-blue-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                    <span id="generate-cover-letter-text">Generate Cover Letter</span>
                                    <svg id="generate-cover-letter-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Tips Panel -->
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6">
                                <h4 class="font-semibold text-gray-800 mb-3">💡 Cover Letter Tips</h4>
                                <ul class="text-sm text-gray-600 space-y-2">
                                    <li>• Upload your most recent resume for best personalization</li>
                                    <li>• Include the complete job description for keyword matching</li>
                                    <li>• Keep it to one page maximum</li>
                                    <li>• Show specific knowledge about the company</li>
                                    <li>• End with a clear call to action</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Output Section -->
                        <div class="space-y-6">
                            <!-- Generated Cover Letter -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">Generated Cover Letter</h3>
                                    <div id="cover-letter-actions" class="hidden flex items-center space-x-2">
                                        <button id="edit-cover-letter-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center text-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button id="copy-cover-letter-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center text-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            Copy
                                        </button>
                                        <button id="download-cover-letter-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center text-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="cover-letter-output" class="min-h-96 p-4 bg-gray-50 rounded-lg border">
                                    <div class="text-center py-16 text-gray-500">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p class="text-lg font-medium">Your cover letter will appear here</p>
                                        <p class="text-sm">Select a job application and click "Generate Cover Letter" to get started</p>
                                    </div>
                                </div>
                                
                                <!-- Edit Mode -->
                                <div id="cover-letter-edit-mode" class="hidden">
                                    <textarea id="cover-letter-editor" class="w-full h-96 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm" placeholder="Edit your cover letter here..."></textarea>
                                    <div class="flex justify-end space-x-2 mt-4">
                                        <button id="cancel-edit-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                                        <button id="save-edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Letter Analysis -->
                            <div id="cover-letter-analysis" class="hidden bg-white p-6 rounded-xl shadow-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">📊 Letter Analysis</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <div class="font-medium text-blue-800">Word Count</div>
                                        <div id="analysis-word-count" class="text-blue-600">-</div>
                                    </div>
                                    <div class="bg-green-50 p-3 rounded-lg">
                                        <div class="font-medium text-green-800">Readability</div>
                                        <div id="analysis-readability" class="text-green-600">-</div>
                                    </div>
                                    <div class="bg-purple-50 p-3 rounded-lg">
                                        <div class="font-medium text-purple-800">Keywords Matched</div>
                                        <div id="analysis-keywords" class="text-purple-600">-</div>
                                    </div>
                                    <div class="bg-orange-50 p-3 rounded-lg">
                                        <div class="font-medium text-orange-800">Resume Data Used</div>
                                        <div id="analysis-resume-data" class="text-orange-600">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white mt-8 py-4 border-t border-gray-200">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
                Job OS - Your Personal Career Management Tool
            </div>
        </footer>
    </div>

    <!-- Add/Edit Job Application Modal -->
    <div id="job-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="job-modal-title" class="text-2xl font-semibold">Add New Application</h3>
            </div>
            <form id="job-form" class="p-6">
                <input type="hidden" id="job-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input type="text" id="j-company" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Position Title</label>
                        <input type="text" id="j-positionTitle" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Application Submission Date</label>
                        <input type="date" id="j-submissionDate" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Employment Type</label>
                        <select id="j-employmentType" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>Part-time</option>
                            <option>Full-time</option>
                            <option>Internship</option>
                            <option>Contract</option>
                        </select>
                    </div>
                    <!-- Column 2 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">App Status</label>
                        <select id="j-appStatus" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>Waiting for application response</option>
                            <option>Application under review</option>
                            <option>Denied without an interview</option>
                            <option>I rejected an interview invitation</option>
                            <option>I withdrew my app</option>
                            <option>First round interview</option>
                            <option>Second round interview</option>
                            <option>Third round interview</option>
                            <option>Fourth round interview</option>
                            <option>First round interview then I never heard from them</option>
                            <option>Second round interview then I never heard from them</option>
                            <option>Third round interview then I never heard from them</option>
                            <option>Fourth round interview then I never heard from them</option>
                            <option>Denied after first round interview</option>
                            <option>Denied after second round interview</option>
                            <option>Denied after third round interview</option>
                            <option>Denied after fourth round interview</option>
                            <option>Waiting for offer</option>
                            <option>I accepted their offer</option>
                            <option>I rejected their offer</option>
                            <option>Position was filled before I interviewed</option>
                        </select>
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">My Qualification Level</label>
                        <select id="j-qualificationLevel" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>91-100%</option>
                            <option>81-90%</option>
                            <option>71-80%</option>
                            <option>61-70%</option>
                            <option>41-60%</option>
                            <option>20-40%</option>
                            <option>&lt;20%</option>
                            <option>Unsure</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Level of Interest</label>
                        <select id="j-interestLevel" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>I want this job</option>
                            <option>I really want this job</option>
                            <option>I'd like to get an interview</option>
                            <option>I don't care whether or not I get an interview</option>
                            <option>Unsure</option>
                            <option>Not interested but want to keep this networking connection</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Salary (Posted or Offered)</label>
                        <input type="text" id="j-salary" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="$XX,XXX">
                        
                        <!-- Calendar Integration Section -->
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Interview Scheduling
                            </h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Interview Date</label>
                                    <input type="datetime-local" id="j-interviewDate" class="w-full border-gray-300 rounded-lg shadow-sm text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Interview Type</label>
                                    <select id="j-interviewType" class="w-full border-gray-300 rounded-lg shadow-sm text-sm">
                                        <option value="">Select type...</option>
                                        <option value="phone">Phone Interview</option>
                                        <option value="video">Video Interview</option>
                                        <option value="in-person">In-Person Interview</option>
                                        <option value="panel">Panel Interview</option>
                                        <option value="technical">Technical Interview</option>
                                        <option value="behavioral">Behavioral Interview</option>
                                        <option value="final">Final Round</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Interview Location/Link</label>
                                    <input type="text" id="j-interviewLocation" class="w-full border-gray-300 rounded-lg shadow-sm text-sm" placeholder="Office address, Zoom link, or phone number">
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Interviewer(s)</label>
                                    <input type="text" id="j-interviewer" class="w-full border-gray-300 rounded-lg shadow-sm text-sm" placeholder="Names and titles of interviewers">
                                </div>
                            </div>
                            <div class="mt-3 flex items-center">
                                <input type="checkbox" id="j-createCalendarEvent" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <label for="j-createCalendarEvent" class="ml-2 text-sm text-gray-700">Automatically create calendar event</label>
                            </div>
                        </div>
                    </div>
                     <!-- Column 3 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Found Position Via</label>
                        <input type="text" id="j-foundVia" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="e.g., LinkedIn, Handshake">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Job Req Link</label>
                        <input type="url" id="j-reqLink" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="https://...">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Notes</label>
                        <textarea id="j-notes" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm"></textarea>
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Job Description</label>
                        <textarea id="j-description" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm"></textarea>
                    </div>
                </div>
                <!-- Document Management Section -->
                <div class="md:col-span-3 mt-6 pt-6 border-t">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Document Management</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resume</label>
                            <input type="file" id="j-resume" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div id="j-resume-link" class="mt-2 text-sm"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cover Letter</label>
                            <input type="file" id="j-coverLetter" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div id="j-coverLetter-link" class="mt-2 text-sm"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" id="job-cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Save Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div id="contact-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="modal-title" class="text-2xl font-semibold">Add New Contact</h3>
            </div>
            <form id="contact-form" class="p-6">
                <input type="hidden" id="contact-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Column 1 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="name" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Company</label>
                        <input type="text" id="company" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Type</label>
                        <select id="type" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>Professional</option>
                            <option>Academic</option>
                            <option>Recruiter</option>
                            <option>Personal</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Is Reference?</label>
                        <select id="is-reference" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Relationship Standing</label>
                        <select id="relationship-standing" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option value="Active">Active</option>
                            <option value="Lost touch">Lost touch</option>
                        </select>
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Last Communication Date</label>
                        <input type="date" id="last-comm-date" class="w-full border-gray-300 rounded-lg shadow-sm">
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">When we met</label>
                        <input type="date" id="when-we-met" class="w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <!-- Column 2 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Phone</label>
                        <input type="tel" id="phone" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Contact Info (e.g., LinkedIn)</label>
                        <input type="text" id="contact-info" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Last Communication Method</label>
                        <select id="last-comm-method" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>Email</option>
                            <option>LinkedIn</option>
                            <option>Phone Call</option>
                            <option>In-person</option>
                             <option>Unknown</option>
                        </select>
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">How we met</label>
                        <input type="text" id="how-we-met" class="w-full border-gray-300 rounded-lg shadow-sm">
                         <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Notes on the person</label>
                        <textarea id="notes" rows="4" class="w-full border-gray-300 rounded-lg shadow-sm"></textarea>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit History Modal -->
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="history-modal-title" class="text-2xl font-semibold">Add Work History</h3>
            </div>
            <form id="history-form" class="p-6">
                <input type="hidden" id="history-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input type="text" id="h-company" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Starting Position</label>
                        <input type="text" id="h-startPosition" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Start Date</label>
                        <input type="date" id="h-startDate" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Starting Base Salary</label>
                        <input type="text" id="h-startBase" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="$XX,XXX">
                    </div>
                    <!-- Column 2 -->
                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-1">Work Address</label>
                        <input type="text" id="h-address" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Ending Position</label>
                        <input type="text" id="h-endPosition" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">End Date</label>
                        <input type="date" id="h-endDate" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Ending Base Salary</label>
                        <input type="text" id="h-endBase" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="$XX,XXX">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Bonus</label>
                        <input type="text" id="h-bonus" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="$X,XXX">
                    </div>
                     <!-- Column 3 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employment Type</label>
                        <select id="h-employmentType" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option>Full-time</option>
                            <option>Part-time</option>
                            <option>Contract</option>
                            <option>Internship</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Manager(s)</label>
                        <input type="text" id="h-manager" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Reason for leaving</label>
                        <input type="text" id="h-reason" class="w-full border-gray-300 rounded-lg shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Employment Verification Details</label>
                        <textarea id="h-verification" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm"></textarea>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" id="history-cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Save Job</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="task-modal-title" class="text-2xl font-semibold">Add Task</h3>
            </div>
            <form id="task-form" class="p-6">
                <input type="hidden" id="task-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                        <input type="text" id="t-title" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Follow up with Google" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="t-description" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Additional details about this task..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="t-priority" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option value="high">🔴 High Priority</option>
                            <option value="medium" selected>🟡 Medium Priority</option>
                            <option value="low">🟢 Low Priority</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="t-dueDate" class="w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Related Job (Optional)</label>
                        <select id="t-relatedJob" class="w-full border-gray-300 rounded-lg shadow-sm">
                            <option value="">No related job</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" id="task-cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">Save Task</button>
                </div>
            </form>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
    const userProvidedConfig = {
      apiKey: "AIzaSyDeyI9tEiu3hUSFqaUDGREiqFJ30IyxpzQ",
      authDomain: "job-tracker-8a255.firebaseapp.com",
      projectId: "job-tracker-8a255",
      storageBucket: "job-tracker-8a255.firebasestorage.app",
      messagingSenderId: "693983521",
      appId: "1:693983521:web:d435bef69046af167c4660",
      measurementId: "G-FSSJ1KVXP6"
    };
    
    let db, auth, storage, userId;
    let contactsUnsubscribe = null, historyUnsubscribe = null, jobsUnsubscribe = null, tasksUnsubscribe = null;
    let allJobs = [], allContacts = [], allTasks = [];
    let funnelChart = null;
    let draggedJobId = null;

    const navTabs = document.querySelectorAll('.nav-tab');
    const appViews = document.querySelectorAll('.app-view');
    const metricApps = document.getElementById('metric-apps');
    const metricInterviews = document.getElementById('metric-interviews');
    const metricOffers = document.getElementById('metric-offers');
    const metricContacts = document.getElementById('metric-contacts');
    const viewTableBtn = document.getElementById('view-table-btn');
    const viewBoardBtn = document.getElementById('view-board-btn');
    const jobsTableView = document.getElementById('jobs-table-view');
    const jobsBoardView = document.getElementById('jobs-board-view');
    const kanbanBoard = document.getElementById('kanban-board');
    const addJobBtn = document.getElementById('add-job-btn');
    const jobModal = document.getElementById('job-modal');
    const jobForm = document.getElementById('job-form');
    const jobCancelBtn = document.getElementById('job-cancel-btn');
    const jobModalTitle = document.getElementById('job-modal-title');
    const jobIdField = document.getElementById('job-id');
    const jobsTableContainer = document.getElementById('jobs-table-container');
    const addContactBtn = document.getElementById('add-contact-btn');
    const contactModal = document.getElementById('contact-modal');
    const contactForm = document.getElementById('contact-form');
    const cancelBtn = document.getElementById('cancel-btn');
    const modalTitle = document.getElementById('modal-title');
    const contactIdField = document.getElementById('contact-id');
    const networkTableContainer = document.getElementById('network-table-container');
    const loadingState = document.getElementById('loading-state');
    const addHistoryBtn = document.getElementById('add-history-btn');
    const historyModal = document.getElementById('history-modal');
    const historyForm = document.getElementById('history-form');
    const historyCancelBtn = document.getElementById('history-cancel-btn');
    const historyModalTitle = document.getElementById('history-modal-title');
    const historyIdField = document.getElementById('history-id');
    const historyTableContainer = document.getElementById('history-table-container');
    const authStatus = document.getElementById('auth-status');
    
    // Task Management Elements
    const addTaskBtn = document.getElementById('add-task-btn');
    const taskModal = document.getElementById('task-modal');
    const taskForm = document.getElementById('task-form');
    const taskCancelBtn = document.getElementById('task-cancel-btn');
    const taskModalTitle = document.getElementById('task-modal-title');
    const taskIdField = document.getElementById('task-id');
    const tasksContainer = document.getElementById('tasks-container');
    const noTasksDiv = document.getElementById('no-tasks');

    async function initializeFirebase() {
        console.log('🔥 Starting Firebase initialization...'); // Debug log
        const authStatus = document.getElementById('auth-status');
        try {
            const finalConfig = userProvidedConfig;
            console.log('📝 Firebase config:', finalConfig.projectId); // Debug log

            firebase.initializeApp(finalConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            console.log('✅ Firebase services initialized'); // Debug log

            auth.onAuthStateChanged(async (user) => {
                console.log('🔐 Auth state changed:', user ? `User: ${user.uid}` : 'No user'); // Debug log
                
                if (user) {
                    userId = user.uid;
                    authStatus.textContent = `User ID: ${userId.substring(0,8)}...`;
                    authStatus.classList.remove('text-red-500');
                    
                    // Store user ID in localStorage for persistence tracking
                    localStorage.setItem('jobos_user_id', userId);
                    localStorage.setItem('jobos_last_login', new Date().toISOString());
                    
                    console.log('📊 Loading user data...'); // Debug log
                    fetchJobs();
                    fetchContacts();
                    fetchHistory();
                    fetchTasks();
                } else {
                    userId = null;
                    authStatus.textContent = "Authenticating...";
                    console.log('🚪 No user, rendering empty data...'); // Debug log
                    renderJobs([]);
                    renderContacts([]);
                    renderHistory([]);
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                         console.error("Anonymous sign-in failed:", error);
                        if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/configuration-not-found') {
                             authStatus.innerHTML = `
                                <div class="text-red-500 font-sans">
                                    <strong>Action Required:</strong> Please enable Anonymous Sign-In in your Firebase project.
                                    <ol class="list-decimal list-inside text-left mt-1 text-xs">
                                        <li>Go to your Firebase Console.</li>
                                        <li>Navigate to <strong>Build > Authentication</strong>.</li>
                                        <li>Click <strong>"Get started"</strong>, then select <strong>Anonymous</strong> and enable it.</li>
                                    </ol>
                                </div>`;
                        } else {
                            authStatus.textContent = `Auth Error: ${error.code}`;
                            authStatus.classList.add('text-red-500');
                        }
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            authStatus.textContent = `Initialization Error: ${error.message}`;
            authStatus.classList.add('text-red-500');
        }
    }

    function switchTab(tab) {
        navTabs.forEach(t => t.classList.remove('active-tab'));
        tab.classList.add('active-tab');

        const targetViewId = tab.dataset.tab + '-view';
        appViews.forEach(view => {
            view.id === targetViewId ? view.classList.remove('hidden') : view.classList.add('hidden');
        });
        
        // Initialize Smart Resume when tab is opened
        if (tab.dataset.tab === 'smart-resume') {
            setTimeout(() => {
                initializeResumeInputHandlers();
            }, 100);
        }
        
        // Initialize Interview Prep when tab is opened
        if (tab.dataset.tab === 'interview-prep') {
            setTimeout(() => {
                populateJobSelection();
            }, 100);
        }
        
        // Initialize Cover Letter when tab is opened
        if (tab.dataset.tab === 'cover-letter') {
            setTimeout(() => {
                // Cover letter is self-contained, no job population needed
                console.log('📝 Cover Letter tab opened');
                
                // Ensure event listeners are attached (fallback)
                const generateBtn = document.getElementById('generate-cover-letter-btn');
                if (generateBtn && !generateBtn.hasAttribute('data-listener-attached')) {
                    console.log('🔄 Reattaching Cover Letter event listeners...');
                    generateBtn.addEventListener('click', generateNewCoverLetter);
                    generateBtn.setAttribute('data-listener-attached', 'true');
                }
            }, 100);
        }
    }

    function openJobModal(job = null) {
        jobForm.reset();
        document.getElementById('j-resume-link').innerHTML = '';
        document.getElementById('j-coverLetter-link').innerHTML = '';

        jobIdField.value = job ? job.id : '';
        jobModalTitle.textContent = job ? 'Edit Application' : 'Add New Application';
        if (job) {
            Object.keys(job).forEach(key => {
                const element = document.getElementById(`j-${key}`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = job[key];
                    } else {
                        element.value = job[key] || '';
                    }
                }
            });
            if (job.resumeUrl) {
                document.getElementById('j-resume-link').innerHTML = `<a href="${job.resumeUrl}" target="_blank" class="text-indigo-600 hover:underline">View current resume</a>`;
            }
            if (job.coverLetterUrl) {
                document.getElementById('j-coverLetter-link').innerHTML = `<a href="${job.coverLetterUrl}" target="_blank" class="text-indigo-600 hover:underline">View current cover letter</a>`;
            }
        } else {
            // Set default values for new applications
            document.getElementById('j-createCalendarEvent').checked = true;
        }
        jobModal.classList.add('active');
    }
    function closeJobModal() { jobModal.classList.remove('active'); }

    function openModal(contact = null) {
        contactForm.reset();
        contactIdField.value = contact ? contact.id : '';
        modalTitle.textContent = contact ? 'Edit Contact' : 'Add New Contact';
        if (contact) {
            Object.keys(contact).forEach(key => {
                const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                if(element) element.value = contact[key];
            });
        }
        contactModal.classList.add('active');
    }
    function closeModal() { contactModal.classList.remove('active'); }

    function openHistoryModal(job = null) {
        historyForm.reset();
        historyIdField.value = job ? job.id : '';
        historyModalTitle.textContent = job ? 'Edit Work History' : 'Add Work History';
        if (job) {
             Object.keys(job).forEach(key => {
                const element = document.getElementById(`h-${key}`);
                if (element) element.value = job[key];
            });
        }
        historyModal.classList.add('active');
    }
    function closeHistoryModal() { historyModal.classList.remove('active'); }

    function renderJobs(jobs) {
        // Clean up auto-generated tasks for jobs that no longer need them
        if (allTasks.length > 0) {
            cleanupAutoTasks(jobs);
        }
        
        if (jobs.length === 0) {
            jobsTableContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No job applications yet. Add your first one!</p>';
            return;
        }
        jobsTableContainer.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company & Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docs</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Applied</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${jobs.map(job => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${job.company || ''}</div>
                                <div class="text-sm text-gray-500">
                                    ${job.positionTitle || ''}
                                    ${job.interviewDate ? `<span class="calendar-event-indicator ${
                                        new Date(job.interviewDate) > new Date() && new Date(job.interviewDate) < new Date(Date.now() + 7*24*60*60*1000) 
                                        ? 'interview-upcoming' : ''
                                    }">📅 ${new Date(job.interviewDate).toLocaleDateString()}</span>` : ''}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.appStatus || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${job.resumeUrl ? `<a href="${job.resumeUrl}" target="_blank" title="View Resume" class="inline-block text-indigo-600 hover:text-indigo-800 mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-4V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                </a>` : ''}
                                ${job.coverLetterUrl ? `<a href="${job.coverLetterUrl}" target="_blank" title="View Cover Letter" class="inline-block text-indigo-600 hover:text-indigo-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                </a>` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.submissionDate || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="${job.reqLink || '#'}" target="_blank" class="text-blue-600 hover:text-blue-900" ${!job.reqLink ? 'style="display:none;"' : ''}>Link</a>
                                <button class="job-edit-btn text-indigo-600 hover:text-indigo-900 ml-4" data-id="${job.id}">Edit</button>
                                <button class="job-delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${job.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    }

    function renderContacts(contacts) {
        if (contacts.length === 0) {
            networkTableContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No contacts yet. Add your first one!</p>';
            return;
        }
        loadingState.style.display = 'none';
        networkTableContainer.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Standing</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Communication</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email/Phone</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${contacts.map(contact => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${contact.name || ''}</div><div class="text-sm text-gray-500">${contact.type || ''}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${contact.company || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${contact.relationshipStanding === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${contact.relationshipStanding || ''}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><div>${contact.lastCommDate || 'N/A'}</div><div class="text-xs text-gray-500">${contact.lastCommMethod || ''}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><div>${contact.email || ''}</div><div>${contact.phone || ''}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${contact.id}">Edit</button>
                                <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${contact.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    }

    function renderHistory(jobs) {
        if (jobs.length === 0) {
            historyTableContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No work history yet. Add your first job!</p>';
            return;
        }
        historyTableContainer.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                 <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company & Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compensation</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${jobs.map(job => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${job.company || ''}</div><div class="text-sm text-gray-500">${job.endPosition || job.startPosition || ''}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.startDate || ''} to ${job.endDate || 'Present'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><div>${job.endBase || job.startBase || 'N/A'}</div><div class="text-xs text-gray-500">Bonus: ${job.bonus || 'N/A'}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.manager || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="history-edit-btn text-indigo-600 hover:text-indigo-900" data-id="${job.id}">Edit</button>
                                <button class="history-delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${job.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    }
    
    function updateDashboard() {
        metricApps.textContent = allJobs.length;
        const interviews = allJobs.filter(j => getKanbanColumnForStatus(j.appStatus) === 'Interviewing').length;
        const offers = allJobs.filter(j => getKanbanColumnForStatus(j.appStatus) === 'Offer').length;
        metricInterviews.textContent = interviews;
        metricOffers.textContent = offers;
        metricContacts.textContent = allContacts.filter(c => c.relationshipStanding === 'Active').length;

        const applied = allJobs.length - interviews - offers;
        const chartData = {
            labels: ['Applied', 'Interviewing', 'Offers'],
            datasets: [{
                label: 'Applications',
                data: [applied, interviews, offers],
                backgroundColor: ['#6366f1', '#3b82f6', '#10b981'],
                borderColor: ['#4f46e5', '#2563eb', '#059669'],
                borderWidth: 1
            }]
        };

        if (funnelChart) {
            funnelChart.data = chartData;
            funnelChart.update();
        } else {
            const ctx = document.getElementById('funnel-chart').getContext('2d');
            funnelChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    const KANBAN_COLUMNS = {
        APPLIED: 'Applied',
        INTERVIEWING: 'Interviewing',
        OFFER: 'Offer',
        CLOSED: 'Closed'
    };

    function getKanbanColumnForStatus(status) {
        if (!status) return KANBAN_COLUMNS.APPLIED;
        const s = status.toLowerCase();
        if (s.includes('offer')) return KANBAN_COLUMNS.OFFER;
        if (s.includes('interview')) return KANBAN_COLUMNS.INTERVIEWING;
        if (s.includes('denied') || s.includes('rejected') || s.includes('withdrew') || s.includes('filled')) return KANBAN_COLUMNS.CLOSED;
        return KANBAN_COLUMNS.APPLIED;
    }
    
    function renderKanbanBoard(jobs) {
        kanbanBoard.innerHTML = ''; 

        const columns = {
            [KANBAN_COLUMNS.APPLIED]: [],
            [KANBAN_COLUMNS.INTERVIEWING]: [],
            [KANBAN_COLUMNS.OFFER]: [],
            [KANBAN_COLUMNS.CLOSED]: [],
        };

        jobs.forEach(job => {
            const column = getKanbanColumnForStatus(job.appStatus);
            columns[column].push(job);
        });

        for (const [columnName, jobsInColumn] of Object.entries(columns)) {
            const columnEl = document.createElement('div');
            columnEl.className = 'kanban-column flex-shrink-0 w-72 bg-gray-100 rounded-lg';
            columnEl.dataset.columnName = columnName;

            const headerEl = document.createElement('div');
            headerEl.className = 'p-3 font-semibold text-gray-700 border-b border-gray-300';
            headerEl.textContent = `${columnName} (${jobsInColumn.length})`;
            
            const cardContainerEl = document.createElement('div');
            cardContainerEl.className = 'p-3 space-y-3 h-full overflow-y-auto';
            cardContainerEl.dataset.column = columnName;
            
            jobsInColumn.forEach(job => {
                const cardEl = document.createElement('div');
                cardEl.className = 'kanban-card bg-white p-3 rounded-md shadow';
                cardEl.draggable = true;
                cardEl.dataset.id = job.id;
                cardEl.innerHTML = `
                    <p class="font-semibold text-gray-800">${job.positionTitle}</p>
                    <p class="text-sm text-gray-600">${job.company}</p>
                    <p class="text-xs text-gray-400 mt-2">${job.appStatus}</p>
                    ${job.interviewDate ? `
                        <div class="mt-2 flex items-center text-xs">
                            <span class="calendar-event-indicator ${
                                new Date(job.interviewDate) > new Date() && new Date(job.interviewDate) < new Date(Date.now() + 7*24*60*60*1000) 
                                ? 'interview-upcoming' : ''
                            }">📅 ${new Date(job.interviewDate).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                `;
                cardContainerEl.appendChild(cardEl);
            });

            columnEl.appendChild(headerEl);
            columnEl.appendChild(cardContainerEl);
            kanbanBoard.appendChild(columnEl);
        }
    }
    
    function fetchJobs() {
        console.log('📋 Fetching jobs for user:', userId); // Debug log
        if (!userId) {
            console.log('❌ No userId, cannot fetch jobs'); // Debug log
            
            // Try to recover from localStorage backup
            const backup = localStorage.getItem('jobos_backup_jobs');
            if (backup) {
                try {
                    const backupData = JSON.parse(backup);
                    console.log('🔄 Recovered backup data:', backupData.data.length, 'jobs');
                    allJobs = backupData.data;
                    renderJobs(allJobs);
                    renderKanbanBoard(allJobs);
                    showToast('Loaded backup data (offline mode)', 'info');
                } catch (e) {
                    console.error('❌ Failed to parse backup data:', e);
                }
            }
            return;
        }
        if (jobsUnsubscribe) jobsUnsubscribe();
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('jobs');
        jobsUnsubscribe = ref.orderBy('submissionDate', 'desc').onSnapshot(snapshot => {
            console.log('📊 Jobs snapshot received:', snapshot.docs.length, 'jobs'); // Debug log
            allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Backup data to localStorage for data persistence
            if (allJobs.length > 0) {
                localStorage.setItem('jobos_backup_jobs', JSON.stringify({
                    data: allJobs,
                    timestamp: new Date().toISOString(),
                    userId: userId
                }));
                console.log('💾 Data backed up to localStorage'); // Debug log
            }
            
            console.log('📋 All jobs loaded:', allJobs.length); // Debug log
            renderJobs(allJobs);
            renderKanbanBoard(allJobs);
            updateDashboard();
        }, e => {
            console.error("❌ Error fetching jobs: ", e);
            console.log('🔍 Trying to fetch jobs from path:', ref.path);
        });
    }
    
    function fetchContacts() {
        if (!userId) return;
        if (contactsUnsubscribe) contactsUnsubscribe();
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('contacts');
        contactsUnsubscribe = ref.onSnapshot(snapshot => {
            allContacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allContacts.sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
            renderContacts(allContacts);
            updateDashboard();
        }, e => console.error("Error fetching contacts: ", e));
    }

    function fetchHistory() {
        if (!userId) return;
        if (historyUnsubscribe) historyUnsubscribe();
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('history');
        historyUnsubscribe = ref.orderBy('startDate', 'desc').onSnapshot(snapshot => {
            renderHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }, e => console.error("Error fetching work history: ", e));
    }
    
    // ===== INTELLIGENT TASK MANAGEMENT =====
    
    function generateSmartTasks() {
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
        
        allJobs.forEach(job => {
            // Auto-generate follow-up tasks for applications waiting > 1 week
            if (job.appStatus === 'Waiting for application response' && job.submissionDate) {
                const submissionDate = new Date(job.submissionDate);
                if (submissionDate <= oneWeekAgo) {
                    // Check if follow-up task already exists
                    const existingTask = allTasks.find(task => 
                        task.type === 'auto-followup' && 
                        task.relatedJobId === job.id
                    );
                    
                    if (!existingTask) {
                        createAutoTask({
                            title: `Follow up with ${job.company}`,
                            description: `It's been a week since you applied for ${job.positionTitle}. Consider sending a polite follow-up email.`,
                            priority: 'medium',
                            type: 'auto-followup',
                            relatedJobId: job.id,
                            dueDate: formatDate(threeDaysFromNow)
                        });
                    }
                }
            }
            
            // Auto-generate interview prep tasks
            if (job.appStatus && job.appStatus.toLowerCase().includes('interview')) {
                const existingPrepTask = allTasks.find(task => 
                    task.type === 'auto-interview-prep' && 
                    task.relatedJobId === job.id
                );
                
                if (!existingPrepTask) {
                    createAutoTask({
                        title: `Prepare for ${job.company} interview`,
                        description: `Research ${job.company}'s recent news, practice common interview questions, and review the job description for ${job.positionTitle}.`,
                        priority: 'high',
                        type: 'auto-interview-prep',
                        relatedJobId: job.id,
                        dueDate: formatDate(new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000))
                    });
                }
            }
            
            // Auto-generate thank you note tasks after interviews
            if (job.appStatus && (job.appStatus.includes('round interview') || job.appStatus.includes('interview then'))) {
                const existingThankYouTask = allTasks.find(task => 
                    task.type === 'auto-thank-you' && 
                    task.relatedJobId === job.id
                );
                
                if (!existingThankYouTask) {
                    createAutoTask({
                        title: `Send thank you note to ${job.company}`,
                        description: `Send a personalized thank you email within 24 hours of your interview for ${job.positionTitle}.`,
                        priority: 'high',
                        type: 'auto-thank-you',
                        relatedJobId: job.id,
                        dueDate: formatDate(new Date(now.getTime() + 1 * 24 * 60 * 60 * 1000))
                    });
                }
            }
        });
        
        // Auto-generate networking tasks
        const inactiveContacts = allContacts.filter(contact => {
            if (!contact.lastCommDate || contact.relationshipStanding !== 'Active') return false;
            const lastComm = new Date(contact.lastCommDate);
            const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            return lastComm <= threeMonthsAgo;
        });
        
        inactiveContacts.forEach(contact => {
            const existingNetworkTask = allTasks.find(task => 
                task.type === 'auto-network' && 
                task.relatedContactId === contact.id
            );
            
            if (!existingNetworkTask) {
                createAutoTask({
                    title: `Reconnect with ${contact.name}`,
                    description: `It's been a while since you last spoke with ${contact.name} at ${contact.company}. Consider reaching out with a friendly message.`,
                    priority: 'low',
                    type: 'auto-network',
                    relatedContactId: contact.id,
                    dueDate: formatDate(new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000))
                });
            }
        });
    }
    
    function createAutoTask(taskData) {
        if (!userId) return;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('tasks');
        ref.add({
            ...taskData,
            completed: false,
            createdAt: new Date().toISOString(),
            isAutoGenerated: true
        }).catch(e => console.error("Error creating auto task: ", e));
    }
    
    function fetchTasks() {
        if (!userId) return;
        if (tasksUnsubscribe) tasksUnsubscribe();
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('tasks');
        tasksUnsubscribe = ref.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTasks();
            generateSmartTasks(); // Generate new smart tasks when data changes
        }, e => console.error("Error fetching tasks: ", e));
    }
    
    function renderTasks() {
        const incompleteTasks = allTasks.filter(task => !task.completed);
        
        if (incompleteTasks.length === 0) {
            noTasksDiv.style.display = 'block';
            tasksContainer.innerHTML = '';
            return;
        }
        
        noTasksDiv.style.display = 'none';
        
        // Sort tasks by priority and due date
        const sortedTasks = incompleteTasks.sort((a, b) => {
            const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            const aPriority = priorityOrder[a.priority] || 2;
            const bPriority = priorityOrder[b.priority] || 2;
            
            if (aPriority !== bPriority) return bPriority - aPriority;
            
            const aDate = a.dueDate ? new Date(a.dueDate) : new Date('2099-12-31');
            const bDate = b.dueDate ? new Date(b.dueDate) : new Date('2099-12-31');
            return aDate - bDate;
        });
        
        tasksContainer.innerHTML = sortedTasks.map(task => {
            const priorityIcon = {
                'high': '🔴',
                'medium': '🟡', 
                'low': '🟢'
            }[task.priority] || '🟡';
            
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date();
            const dueDateClass = isOverdue ? 'text-red-600 font-semibold' : 'text-gray-500';
            
            const relatedJob = task.relatedJobId ? allJobs.find(j => j.id === task.relatedJobId) : null;
            const relatedContact = task.relatedContactId ? allContacts.find(c => c.id === task.relatedContactId) : null;
            
            return `
                <div class="task-item bg-gray-50 p-4 rounded-lg border-l-4 ${
                    task.priority === 'high' ? 'border-red-500' : 
                    task.priority === 'medium' ? 'border-yellow-500' : 'border-green-500'
                }">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="mr-2">${priorityIcon}</span>
                                <h4 class="font-semibold text-gray-800">${task.title}</h4>
                                ${task.isAutoGenerated ? '<span class="ml-2 text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">Auto</span>' : ''}
                            </div>
                            ${task.description ? `<p class="text-sm text-gray-600 mb-2">${task.description}</p>` : ''}
                            <div class="flex items-center text-xs text-gray-500 space-x-4">
                                ${task.dueDate ? `<span class="${dueDateClass}">Due: ${formatDisplayDate(task.dueDate)}</span>` : ''}
                                ${relatedJob ? `<span>📋 ${relatedJob.company} - ${relatedJob.positionTitle}</span>` : ''}
                                ${relatedContact ? `<span>👤 ${relatedContact.name}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="task-complete-btn text-green-600 hover:text-green-800 text-sm" data-id="${task.id}" title="Mark Complete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                            ${!task.isAutoGenerated ? `
                                <button class="task-edit-btn text-indigo-600 hover:text-indigo-800 text-sm" data-id="${task.id}" title="Edit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button class="task-delete-btn text-red-600 hover:text-red-800 text-sm" data-id="${task.id}" title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function openTaskModal(task = null) {
        taskForm.reset();
        taskIdField.value = task ? task.id : '';
        taskModalTitle.textContent = task ? 'Edit Task' : 'Add Task';
        
        // Populate related jobs dropdown
        const relatedJobSelect = document.getElementById('t-relatedJob');
        relatedJobSelect.innerHTML = '<option value="">No related job</option>';
        allJobs.forEach(job => {
            const option = document.createElement('option');
            option.value = job.id;
            option.textContent = `${job.company} - ${job.positionTitle}`;
            relatedJobSelect.appendChild(option);
        });
        
        if (task) {
            document.getElementById('t-title').value = task.title || '';
            document.getElementById('t-description').value = task.description || '';
            document.getElementById('t-priority').value = task.priority || 'medium';
            document.getElementById('t-dueDate').value = task.dueDate || '';
            document.getElementById('t-relatedJob').value = task.relatedJobId || '';
        }
        
        taskModal.classList.add('active');
    }
    
    function closeTaskModal() {
        taskModal.classList.remove('active');
    }
    
    async function saveTask(event) {
        event.preventDefault();
        if (!userId) return;
        
        const data = {
            title: document.getElementById('t-title').value,
            description: document.getElementById('t-description').value,
            priority: document.getElementById('t-priority').value,
            dueDate: document.getElementById('t-dueDate').value,
            relatedJobId: document.getElementById('t-relatedJob').value || null,
            completed: false,
            isAutoGenerated: false
        };
        
        const id = taskIdField.value;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('tasks');
        
        try {
            if (id) {
                await ref.doc(id).update(data);
            } else {
                await ref.add({
                    ...data,
                    createdAt: new Date().toISOString()
                });
            }
            closeTaskModal();
        } catch (e) {
            console.error("Error saving task: ", e);
        }
    }
    
    async function handleTaskAction(event) {
        const target = event.target.closest('button');
        if (!target) return;
        
        const id = target.dataset.id;
        if (!id || !userId) return;
        
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('tasks').doc(id);
        
        if (target.classList.contains('task-complete-btn')) {
            await ref.update({ completed: true, completedAt: new Date().toISOString() });
        }
        
        if (target.classList.contains('task-edit-btn')) {
            const task = allTasks.find(t => t.id === id);
            if (task) openTaskModal(task);
        }
        
        if (target.classList.contains('task-delete-btn')) {
            if (confirm('Are you sure you want to delete this task?')) {
                await ref.delete();
            }
        }
    }
    
    function formatDisplayDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
    }
    
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    // ===== CALENDAR INTEGRATION =====
    
    function formatDateTimeForCalendar(dateTimeString) {
        if (!dateTimeString) return '';
        const date = new Date(dateTimeString);
        return date.toISOString().replace(/[:-]/g, '').split('.')[0] + 'Z';
    }
    
    function createCalendarEvent(jobData) {
        if (!jobData.interviewDate || !jobData.createCalendarEvent) return;
        
        const startDate = new Date(jobData.interviewDate);
        const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // 1 hour duration
        
        const eventDetails = {
            title: `Interview: ${jobData.positionTitle} at ${jobData.company}`,
            start: formatDateTimeForCalendar(startDate),
            end: formatDateTimeForCalendar(endDate),
            description: createEventDescription(jobData),
            location: jobData.interviewLocation || 'TBD'
        };
        
        // Try Google Calendar first, then fall back to other options
        createGoogleCalendarEvent(eventDetails, jobData);
    }
    
    function createEventDescription(jobData) {
        let description = `Interview for ${jobData.positionTitle} position at ${jobData.company}\n\n`;
        
        if (jobData.interviewType) {
            description += `Interview Type: ${jobData.interviewType}\n`;
        }
        
        if (jobData.interviewer) {
            description += `Interviewer(s): ${jobData.interviewer}\n`;
        }
        
        if (jobData.interviewLocation) {
            description += `Location/Link: ${jobData.interviewLocation}\n`;
        }
        
        description += `\nApplication Status: ${jobData.appStatus}\n`;
        
        if (jobData.salary) {
            description += `Salary: ${jobData.salary}\n`;
        }
        
        description += `\n📋 View full application details in Job OS\n`;
        description += `🎯 Interview Preparation Tips:\n`;
        description += `• Research ${jobData.company}'s recent news and developments\n`;
        description += `• Review the job description and prepare specific examples\n`;
        description += `• Prepare thoughtful questions about the role and company\n`;
        description += `• Practice common interview questions\n`;
        description += `• Plan your outfit and route (if in-person)\n`;
        
        return description;
    }
    
    function createGoogleCalendarEvent(eventDetails, jobData) {
        // Create Google Calendar URL for event creation
        const baseUrl = 'https://calendar.google.com/calendar/render';
        const params = new URLSearchParams({
            action: 'TEMPLATE',
            text: eventDetails.title,
            dates: `${eventDetails.start}/${eventDetails.end}`,
            details: eventDetails.description,
            location: eventDetails.location,
            sf: true,
            output: 'xml'
        });
        
        const calendarUrl = `${baseUrl}?${params.toString()}`;
        
        // Show calendar integration modal
        showCalendarIntegrationModal(calendarUrl, eventDetails, jobData);
    }
    
    function showCalendarIntegrationModal(googleUrl, eventDetails, jobData) {
        const modal = document.createElement('div');
        modal.className = 'modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-40 active';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Add to Calendar
                    </h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">Choose how you'd like to add this interview to your calendar:</p>
                    
                    <div class="space-y-3">
                        <button onclick="window.open('${googleUrl}', '_blank'); closeCalendarModal()" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            </svg>
                            Add to Google Calendar
                        </button>
                        
                        <button onclick="downloadICSFile('${encodeURIComponent(JSON.stringify(eventDetails))}', '${encodeURIComponent(JSON.stringify(jobData))}'); closeCalendarModal()" class="w-full flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download .ics File (Outlook/Apple)
                        </button>
                        
                        <button onclick="copyEventDetails('${encodeURIComponent(JSON.stringify(eventDetails))}'); closeCalendarModal()" class="w-full flex items-center justify-center px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Copy Event Details
                        </button>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                        <p class="font-medium mb-1">📅 ${eventDetails.title}</p>
                        <p>🕒 ${new Date(jobData.interviewDate).toLocaleString()}</p>
                        ${eventDetails.location !== 'TBD' ? `<p>📍 ${eventDetails.location}</p>` : ''}
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end">
                    <button onclick="closeCalendarModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition duration-200">Skip for Now</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Store reference for cleanup
        window.currentCalendarModal = modal;
    }
    
    function closeCalendarModal() {
        if (window.currentCalendarModal) {
            window.currentCalendarModal.remove();
            window.currentCalendarModal = null;
        }
    }
    
    // ===== SMART RESUME AI FUNCTIONALITY =====
    
    let uploadedResumeFile = null;

    
    // Initialize resume input type handlers
    function initializeResumeInputHandlers() {
        console.log('Initializing Smart Resume handlers...');
        
        const radioButtons = document.querySelectorAll('input[name="resume-input-type"]');
        const uploadSection = document.getElementById('resume-upload-section');
        const textSection = document.getElementById('resume-text-section');
        const fileInput = document.getElementById('resume-pdf-input');
        const uploadArea = document.getElementById('upload-area');
        
        if (!radioButtons.length || !uploadSection || !textSection) {
            console.log('Smart Resume elements not found, skipping initialization');
            return;
        }
        
        console.log('Smart Resume elements found, setting up handlers');
        
        radioButtons.forEach(radio => {
            radio.addEventListener('change', () => {
                console.log('Radio changed to:', radio.value);
                if (radio.value === 'upload') {
                    uploadSection.classList.remove('hidden');
                    textSection.classList.add('hidden');
                } else {
                    uploadSection.classList.add('hidden');
                    textSection.classList.remove('hidden');
                }
            });
        });
        
        // Handle file upload
        if (fileInput) {
            fileInput.addEventListener('change', handleResumeFileUpload);
        }
        
        // Handle drag and drop
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-indigo-400', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    fileInput.files = files;
                    handleResumeFileUpload({ target: { files: files } });
                }
            });
        }
        
        console.log('Smart Resume handlers initialized successfully');
    }
    
    function handleResumeFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showToast('Please upload a PDF file only', 'error');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        uploadedResumeFile = file;
        
        // Show file info
        document.getElementById('upload-area').classList.add('hidden');
        const fileInfo = document.getElementById('uploaded-file-info');
        document.getElementById('file-name').textContent = file.name;
        fileInfo.classList.remove('hidden');
        
        // Extract text from PDF (simulated - in real implementation you'd use PDF.js)
        extractTextFromPDF(file);
    }
    
    function clearUploadedFile() {
        uploadedResumeFile = null;
        extractedResumeText = null;
        const fileInput = document.getElementById('resume-pdf-input');
        const uploadArea = document.getElementById('upload-area');
        const fileInfo = document.getElementById('uploaded-file-info');
        
        if (fileInput) fileInput.value = '';
        if (uploadArea) uploadArea.classList.remove('hidden');
        if (fileInfo) fileInfo.classList.add('hidden');
    }
    
    async function extractTextFromPDF(file) {
        // In a real implementation, you would use PDF.js or a server-side PDF parser
        // For this demo, we'll simulate PDF text extraction
        showToast('Extracting text from PDF...', 'info');
        
        // Simulate PDF processing
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Simulated extracted text (in real implementation, this would be actual PDF content)
        extractedResumeText = `Ibrahim Denis Fofanah
Somerset, NJ | (732) 318 9987 | fofahibrahimdenis060@outlook.com
LinkedIn | GitHub | Website

PROFESSIONAL SUMMARY
Data Science Master's student with a strong foundation in predictive modeling, statistical analysis, and machine learning. Skilled in building end-to-end data pipelines and translating complex data problems into actionable insights. Proven ability to leverage Python, SQL, and cloud platforms (AWS, GCP) to develop data-driven solutions.

EDUCATION
Pace University – New York, NY
MSc in Data Science (GPA: 3.88) Expected Dec 2025
Njala University – Sierra Leone
BSc in Business & Information Technology (First Class Honors, GPA: 4.37) June 2022

TECHNICAL SKILLS
Languages & Databases: Python (Pandas, Seaborn), SQL (PostgreSQL, MySQL), VBA
Analytics & BI Tools: Power BI, Tableau, Excel, Advanced statistical analysis
Cloud & DevOps: AWS (S3, EC2, Lambda), Google Cloud Platform, Git, GitHub
Data Science & ML: Scikit-learn, TensorFlow, Keras, NumPy, Matplotlib, Statistical Modeling

PROFESSIONAL EXPERIENCE
Data Analyst Intern | ABC Analytics | June 2024 – August 2024
• Analyzed customer behavior data using Python and SQL, identifying key trends that improved retention by 15%
• Built automated dashboards in Power BI that reduced manual reporting time by 40%
• Collaborated with cross-functional teams to implement data-driven marketing strategies

Research Assistant | Pace University | September 2023 – Present
• Conducted statistical analysis on large datasets using Python and R
• Presented findings to faculty and peer researchers at university symposiums
• Maintained databases and ensured data quality across multiple research projects`;
        
        showToast('Resume text extracted successfully!', 'success');
    }
    
    // Smart Resume PDF Upload functions
    let extractedResumeText = '';
    
    function initializeSmartResume() {
        console.log('Initializing Smart Resume...');
        
        // Radio button toggle functionality
        const radioButtons = document.querySelectorAll('input[name="resume-input-type"]');
        const uploadSection = document.getElementById('resume-upload-section');
        const textSection = document.getElementById('resume-text-section');
        
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'upload') {
                    uploadSection.classList.remove('hidden');
                    textSection.classList.add('hidden');
                } else {
                    uploadSection.classList.add('hidden');
                    textSection.classList.remove('hidden');
                }
            });
        });
        
        // File upload handling
        const fileInput = document.getElementById('resume-pdf-input');
        const uploadArea = document.getElementById('upload-area');
        const fileInfo = document.getElementById('uploaded-file-info');
        const fileName = document.getElementById('file-name');
        
        // Click to upload
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('border-indigo-400', 'bg-indigo-50');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
    }
    
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    }
    
    function handleFile(file) {
        // Validate file type
        if (file.type !== 'application/pdf') {
            showToast('Please upload a PDF file only', 'error');
            return;
        }
        
        // Validate file size (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (file.size > maxSize) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Show file info
        const fileName = document.getElementById('file-name');
        const fileInfo = document.getElementById('uploaded-file-info');
        const uploadArea = document.getElementById('upload-area');
        
        fileName.textContent = file.name;
        fileInfo.classList.remove('hidden');
        uploadArea.style.display = 'none';
        
        // Extract text from PDF (simulated)
        extractTextFromPDF(file);
        
        showToast('PDF uploaded successfully!', 'success');
    }
    
    function extractTextFromPDF(file) {
        // Show loading state
        const fileName = document.getElementById('file-name');
        fileName.textContent = `${file.name} (Processing...)`;
        
        // Create FileReader to read the PDF file
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const typedarray = new Uint8Array(event.target.result);
            
            // Load PDF.js library dynamically if not already loaded
            if (typeof pdfjsLib === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = function() {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    processPDF(typedarray, file.name);
                };
                document.head.appendChild(script);
            } else {
                processPDF(typedarray, file.name);
            }
        };
        
        reader.onerror = function() {
            showToast('Error reading PDF file', 'error');
            fileName.textContent = `${file.name} (Error)`;
        };
        
        reader.readAsArrayBuffer(file);
    }
    
    async function processPDF(typedarray, originalFileName) {
        try {
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            
            // Extract text from all pages
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                
                // Combine text items with proper spacing
                const pageText = textContent.items
                    .map(item => item.str)
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                if (pageText) {
                    fullText += pageText + '\n\n';
                }
            }
            
            if (fullText.trim()) {
                extractedResumeText = fullText.trim();
                
                // Update UI to show success
                const fileName = document.getElementById('file-name');
                fileName.textContent = originalFileName;
                
                showToast('PDF text extracted successfully!', 'success');
                console.log('Extracted text preview:', extractedResumeText.substring(0, 200) + '...');
            } else {
                throw new Error('No text found in PDF');
            }
            
        } catch (error) {
            console.error('PDF processing error:', error);
            
            // Fallback: Ask user to paste text instead
            showToast('Could not extract text from PDF. Please use "Paste Text" option instead.', 'warning');
            
            // Switch to text input mode
            const textRadio = document.querySelector('input[name="resume-input-type"][value="text"]');
            const uploadRadio = document.querySelector('input[name="resume-input-type"][value="upload"]');
            const uploadSection = document.getElementById('resume-upload-section');
            const textSection = document.getElementById('resume-text-section');
            
            textRadio.checked = true;
            uploadRadio.checked = false;
            uploadSection.classList.add('hidden');
            textSection.classList.remove('hidden');
            
            // Clear the uploaded file
            window.clearUploadedFile();
        }
    }
    
    window.clearUploadedFile = function() {
        const fileInput = document.getElementById('resume-pdf-input');
        const fileInfo = document.getElementById('uploaded-file-info');
        const uploadArea = document.getElementById('upload-area');
        
        fileInput.value = '';
        fileInfo.classList.add('hidden');
        uploadArea.style.display = 'block';
        extractedResumeText = '';
        
        showToast('File cleared', 'info');
    };
    
    // ===== INTERVIEW PREP AI FUNCTIONALITY =====
    
    let interviewQuestions = [];
    let currentPracticeQuestion = null;
    let currentJobForInterview = null;
    
    function initializeInterviewPrep() {
        console.log('Initializing Interview Prep...');
        
        const jobSelect = document.getElementById('interview-job-select');
        const generateBtn = document.getElementById('generate-questions-btn');
        const selectedJobInfo = document.getElementById('selected-job-info');
        
        if (!jobSelect || !generateBtn) {
            console.log('Interview Prep elements not found, skipping initialization');
            return;
        }
        
        // Populate job selection dropdown
        populateJobSelection();
        
        // Job selection handler
        jobSelect.addEventListener('change', function() {
            const selectedJobId = this.value;
            if (selectedJobId) {
                const job = allJobs.find(j => j.id === selectedJobId);
                if (job) {
                    currentJobForInterview = job;
                    displaySelectedJobInfo(job);
                    selectedJobInfo.classList.remove('hidden');
                } else {
                    selectedJobInfo.classList.add('hidden');
                }
            } else {
                selectedJobInfo.classList.add('hidden');
                currentJobForInterview = null;
            }
        });
        
        // Generate questions handler
        generateBtn.addEventListener('click', generateInterviewQuestions);
        
        // Filter handlers
        document.getElementById('filter-all').addEventListener('click', () => {
            console.log('Showing all questions');
            displayInterviewQuestions(interviewQuestions);
            updateFilterButtons('all');
        });
        document.getElementById('filter-behavioral').addEventListener('click', () => filterQuestions('behavioral'));
        document.getElementById('filter-technical').addEventListener('click', () => filterQuestions('technical'));
        document.getElementById('filter-company').addEventListener('click', () => filterQuestions('company'));
        
        // Practice mode handlers
        document.getElementById('get-feedback-btn').addEventListener('click', generateFeedback);
        document.getElementById('next-question-btn').addEventListener('click', nextPracticeQuestion);
        
        console.log('Interview Prep initialized successfully');
    }
    
    function populateJobSelection() {
        const jobSelect = document.getElementById('interview-job-select');
        
        if (!jobSelect) {
            console.error('Job select element not found');
            return;
        }
        
        console.log('Populating job selection, available jobs:', allJobs.length);
        
        // Debug: Log the structure of jobs to see field names
        if (allJobs.length > 0) {
            console.log('Sample job structure:', allJobs[0]);
            console.log('Available fields:', Object.keys(allJobs[0]));
        }
        
        // Clear existing options (except first)
        while (jobSelect.children.length > 1) {
            jobSelect.removeChild(jobSelect.lastChild);
        }
        
        // Check if there are any jobs
        if (!allJobs || allJobs.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No job applications found. Add jobs in Job Tracker first.';
            option.disabled = true;
            jobSelect.appendChild(option);
            
            // Show helpful message
            const container = document.getElementById('questions-container');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="bg-blue-50 rounded-xl p-8 max-w-md mx-auto">
                            <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Job Applications Found</h3>
                            <p class="text-gray-600 mb-4">To test the Interview Prep feature, you need to add some job applications first.</p>
                            <div class="space-y-2">
                                <button onclick="switchTab(document.querySelector('[data-tab=\\"jobs\\"]'))" class="w-full bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200">
                                    Go to Job Tracker
                                </button>
                                <button onclick="loadDemoJob()" class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                    Try Demo Mode
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        // Add jobs to dropdown
        allJobs.forEach((job, index) => {
            const option = document.createElement('option');
            option.value = job.id;
            
            // Try multiple possible field names for position
            const position = job.position || job.jobTitle || job.title || job.role || job.positionTitle || 'Position Not Specified';
            // Try multiple possible field names for company  
            const company = job.company || job.companyName || job.employer || job.organization || 'Company Not Specified';
            
            console.log(`Job ${index + 1}:`, { position, company, originalJob: job });
            
            option.textContent = `${position} at ${company}`;
            jobSelect.appendChild(option);
        });
        
        console.log('Job selection populated with', allJobs.length, 'jobs');
    }
    
    function displaySelectedJobInfo(job) {
        console.log('Displaying job info for:', job);
        
        // Try multiple possible field names for position
        const position = job.position || job.jobTitle || job.title || job.role || job.positionTitle || 'Position Not Specified';
        // Try multiple possible field names for company  
        const company = job.company || job.companyName || job.employer || job.organization || 'Company Not Specified';
        // Try multiple possible field names for status
        const status = job.appStatus || job.status || job.applicationStatus || 'Status Not Set';
        
        console.log('Extracted fields:', { position, company, status });
        
        document.getElementById('selected-job-title').textContent = position;
        document.getElementById('selected-job-company').textContent = company;
        
        const statusSpan = document.getElementById('selected-job-status');
        statusSpan.textContent = status;
        statusSpan.className = `inline-block px-2 py-1 text-xs rounded-full mt-2 ${getStatusColor(status)}`;
    }
    
    function getStatusColor(status) {
        if (!status) return 'bg-gray-100 text-gray-700';
        
        const statusLower = status.toLowerCase();
        
        if (statusLower.includes('applied') || statusLower.includes('submitted')) {
            return 'bg-blue-100 text-blue-700';
        } else if (statusLower.includes('interview') || statusLower.includes('screening')) {
            return 'bg-yellow-100 text-yellow-700';
        } else if (statusLower.includes('offer') || statusLower.includes('accepted')) {
            return 'bg-green-100 text-green-700';
        } else if (statusLower.includes('rejected') || statusLower.includes('declined')) {
            return 'bg-red-100 text-red-700';
        } else if (statusLower.includes('pending') || statusLower.includes('waiting')) {
            return 'bg-orange-100 text-orange-700';
        } else {
            return 'bg-gray-100 text-gray-700';
        }
    }
    
    async function generateInterviewQuestions() {
        if (!currentJobForInterview) {
            showToast('Please select a job application first', 'error');
            return;
        }
        
        const generateBtn = document.getElementById('generate-questions-btn');
        const originalHTML = generateBtn.innerHTML;
        
        // Show loading state
        generateBtn.disabled = true;
        generateBtn.innerHTML = `
            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating...
        `;
        
        try {
            // Simulate AI processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Generate questions based on job
            console.log('Generating questions for job:', currentJobForInterview);
            interviewQuestions = await generateQuestionsForJob(currentJobForInterview);
            console.log('Generated questions:', interviewQuestions.length);
            
            // Display questions
            displayInterviewQuestions(interviewQuestions);
            
            showToast(`${interviewQuestions.length} interview questions generated successfully!`, 'success');
            
        } catch (error) {
            console.error('Error generating questions:', error);
            showToast('Failed to generate questions. Please try again.', 'error');
        } finally {
            // Reset button
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalHTML;
        }
    }
    
    async function generateQuestionsForJob(job) {
        console.log('🔧 Starting question generation for job:', job);
        
        // AI-powered question generation based on job description and role
        const questions = [];
        
        // Analyze job title and description for question generation
        const jobTitle = (job.position || job.jobTitle || job.title || 'unknown role').toLowerCase();
        const jobDescription = job.jobDescription || job.description || '';
        const company = job.company || job.companyName || job.employer || 'the company';
        
        console.log('📋 Job analysis:', { jobTitle, company, hasDescription: !!jobDescription });
        
        // Behavioral Questions (always relevant)
        const behavioralQuestions = [
            {
                id: 1,
                type: 'behavioral',
                difficulty: 'easy',
                question: 'Tell me about yourself and why you\'re interested in this role.',
                category: 'Introduction',
                tips: 'Structure: Current situation → Relevant experience → Why this role → Future goals'
            },
            {
                id: 2,
                type: 'behavioral',
                difficulty: 'medium',
                question: 'Describe a challenging project you worked on. How did you overcome the obstacles?',
                category: 'Problem Solving',
                tips: 'Use STAR method: Situation, Task, Action, Result. Focus on your specific contributions.'
            },
            {
                id: 3,
                type: 'behavioral',
                difficulty: 'medium',
                question: 'Tell me about a time when you had to work with a difficult team member.',
                category: 'Teamwork',
                tips: 'Show emotional intelligence, conflict resolution, and positive outcomes.'
            },
            {
                id: 4,
                type: 'behavioral',
                difficulty: 'hard',
                question: 'Describe a situation where you failed or made a significant mistake. What did you learn?',
                category: 'Learning & Growth',
                tips: 'Be honest but focus on lessons learned and how you applied them later.'
            }
        ];
        
        // Technical Questions (based on job type)
        let technicalQuestions = [];
        
        if (jobTitle.includes('data') || jobTitle.includes('analyst') || jobTitle.includes('scientist')) {
            technicalQuestions = [
                {
                    id: 5,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'Walk me through your approach to analyzing a large dataset with missing values.',
                    category: 'Data Analysis',
                    tips: 'Discuss data exploration, cleaning strategies, and validation methods.'
                },
                {
                    id: 6,
                    type: 'technical',
                    difficulty: 'hard',
                    question: 'How would you explain a complex statistical concept to a non-technical stakeholder?',
                    category: 'Communication',
                    tips: 'Use analogies, avoid jargon, focus on business impact.'
                },
                {
                    id: 7,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'Describe your experience with Python/R and which libraries you prefer for data analysis.',
                    category: 'Technical Skills',
                    tips: 'Mention specific libraries (pandas, numpy, matplotlib) and use cases.'
                }
            ];
        } else if (jobTitle.includes('software') || jobTitle.includes('developer') || jobTitle.includes('engineer')) {
            technicalQuestions = [
                {
                    id: 5,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'Explain the difference between a stack and a queue, and when you would use each.',
                    category: 'Data Structures',
                    tips: 'Give clear definitions and practical examples from your experience.'
                },
                {
                    id: 6,
                    type: 'technical',
                    difficulty: 'hard',
                    question: 'How do you approach debugging a complex issue in production?',
                    category: 'Problem Solving',
                    tips: 'Discuss systematic approaches, logging, monitoring, and collaboration.'
                },
                {
                    id: 7,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'Describe your experience with version control and collaborative development.',
                    category: 'Development Process',
                    tips: 'Mention Git workflows, code reviews, and team collaboration strategies.'
                }
            ];
        } else if (jobTitle.includes('marketing') || jobTitle.includes('manager')) {
            technicalQuestions = [
                {
                    id: 5,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'How do you measure the success of a marketing campaign?',
                    category: 'Analytics',
                    tips: 'Discuss KPIs, attribution models, and ROI calculations.'
                },
                {
                    id: 6,
                    type: 'technical',
                    difficulty: 'medium',
                    question: 'Describe your experience with digital marketing tools and platforms.',
                    category: 'Tools & Platforms',
                    tips: 'Mention specific tools (Google Analytics, HubSpot, etc.) and results achieved.'
                }
            ];
        }
        
        // Company-specific questions
        const companyQuestions = [
            {
                id: 8,
                type: 'company',
                difficulty: 'easy',
                question: `What do you know about ${company} and why do you want to work here?`,
                category: 'Company Knowledge',
                tips: 'Research company mission, values, recent news, and connect to your goals.'
            },
            {
                id: 9,
                type: 'company',
                difficulty: 'medium',
                question: `How do you see yourself contributing to ${company}'s goals in the first 90 days?`,
                category: 'Impact Planning',
                tips: 'Show you understand the role and have thought about quick wins.'
            },
            {
                id: 10,
                type: 'company',
                difficulty: 'easy',
                question: 'What questions do you have for us about the role or company?',
                category: 'Your Questions',
                tips: 'Prepare thoughtful questions about growth, team dynamics, and challenges.'
            }
        ];
        
        // Combine all questions
        questions.push(...behavioralQuestions, ...technicalQuestions, ...companyQuestions);
        
        console.log('✅ Generated questions:', questions.length, 'total');
        console.log('📊 Breakdown:', {
            behavioral: behavioralQuestions.length,
            technical: technicalQuestions.length, 
            company: companyQuestions.length
        });
        
        return questions;
    }
    
    function displayInterviewQuestions(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        
        if (questions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <p class="text-lg font-medium">No questions available</p>
                    <p class="text-sm">Try generating questions for a different job application</p>
                </div>
            `;
            return;
        }
        
        questions.forEach(question => {
            const questionCard = document.createElement('div');
            questionCard.className = `question-card bg-white p-4 rounded-lg border cursor-pointer hover:shadow-md transition-all duration-200 difficulty-${question.difficulty}`;
            questionCard.onclick = () => startPracticeMode(question);
            
            questionCard.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full ${getQuestionTypeColor(question.type)}">${question.type}</span>
                        <span class="px-2 py-1 text-xs rounded-full ${getDifficultyColor(question.difficulty)}">${question.difficulty}</span>
                    </div>
                    <span class="text-xs text-gray-500">${question.category}</span>
                </div>
                <h4 class="font-medium text-gray-900 mb-2">${question.question}</h4>
                <p class="text-sm text-gray-600">${question.tips}</p>
            `;
            
            container.appendChild(questionCard);
        });
    }
    
    function getQuestionTypeColor(type) {
        switch (type) {
            case 'behavioral': return 'bg-blue-100 text-blue-700';
            case 'technical': return 'bg-green-100 text-green-700';
            case 'company': return 'bg-purple-100 text-purple-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    }
    
    function getDifficultyColor(difficulty) {
        switch (difficulty) {
            case 'easy': return 'bg-green-100 text-green-700';
            case 'medium': return 'bg-yellow-100 text-yellow-700';
            case 'hard': return 'bg-red-100 text-red-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    }
    
    function updateFilterButtons(activeFilter) {
        // Reset all buttons
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
            btn.classList.remove('bg-indigo-200', 'text-indigo-800');
            btn.classList.add('hover:bg-opacity-75');
        });
        
        // Activate selected button
        const activeBtn = document.getElementById(`filter-${activeFilter}`);
        if (activeBtn) {
            activeBtn.classList.add('bg-indigo-200', 'text-indigo-800');
        }
    }
    
    function filterQuestions(type) {
        console.log('Filtering questions by type:', type, 'Total questions:', interviewQuestions.length);
        
        if (!interviewQuestions || interviewQuestions.length === 0) {
            showToast('No questions available to filter. Generate questions first.', 'warning');
            return;
        }
        
        const filteredQuestions = interviewQuestions.filter(q => q.type === type);
        console.log('Filtered questions:', filteredQuestions.length);
        
        displayInterviewQuestions(filteredQuestions);
        updateFilterButtons(type);
    }
    
    function startPracticeMode(question) {
        currentPracticeQuestion = question;
        
        // Hide placeholder and show practice container
        document.getElementById('practice-placeholder').classList.add('hidden');
        document.getElementById('practice-container').classList.remove('hidden');
        
        // Set question
        document.getElementById('practice-question').textContent = question.question;
        
        // Clear previous answer and feedback
        document.getElementById('practice-answer').value = '';
        document.getElementById('feedback-container').classList.add('hidden');
        
        // Scroll to practice panel
        document.getElementById('practice-container').scrollIntoView({ behavior: 'smooth' });
    }
    
    async function generateFeedback() {
        const answer = document.getElementById('practice-answer').value.trim();
        
        if (!answer) {
            showToast('Please enter your answer first', 'error');
            return;
        }
        
        if (!currentPracticeQuestion) {
            showToast('No question selected', 'error');
            return;
        }
        
        const feedbackBtn = document.getElementById('get-feedback-btn');
        const originalHTML = feedbackBtn.innerHTML;
        
        // Show loading state
        feedbackBtn.disabled = true;
        feedbackBtn.innerHTML = 'Analyzing...';
        
        try {
            // Simulate AI feedback generation
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const feedback = await generateAIFeedback(currentPracticeQuestion, answer);
            
            // Display feedback
            document.getElementById('feedback-content').innerHTML = feedback;
            document.getElementById('feedback-container').classList.remove('hidden');
            
            showToast('Feedback generated!', 'success');
            
        } catch (error) {
            console.error('Error generating feedback:', error);
            showToast('Failed to generate feedback. Please try again.', 'error');
        } finally {
            // Reset button
            feedbackBtn.disabled = false;
            feedbackBtn.innerHTML = originalHTML;
        }
    }
    
    async function generateAIFeedback(question, answer) {
        // AI-powered feedback generation
        const answerLength = answer.length;
        const hasSpecificExample = answer.toLowerCase().includes('example') || answer.toLowerCase().includes('project') || answer.toLowerCase().includes('experience');
        const hasNumbers = /\d/.test(answer);
        const hasStructure = answer.includes('.') || answer.includes(',');
        
        let feedback = '<div class="space-y-2">';
        
        // Positive feedback
        const positives = [];
        if (answerLength > 100) positives.push('Good detail level');
        if (hasSpecificExample) positives.push('Includes specific examples');
        if (hasNumbers) positives.push('Uses quantifiable results');
        if (hasStructure) positives.push('Well-structured response');
        
        if (positives.length > 0) {
            feedback += '<div><strong class="text-green-600">Strengths:</strong><ul class="list-disc list-inside ml-2">';
            positives.forEach(positive => {
                feedback += `<li>${positive}</li>`;
            });
            feedback += '</ul></div>';
        }
        
        // Improvement suggestions
        const improvements = [];
        if (answerLength < 50) improvements.push('Consider providing more detail and specific examples');
        if (!hasSpecificExample) improvements.push('Add a specific example from your experience');
        if (!hasNumbers) improvements.push('Include quantifiable results or metrics where possible');
        if (question.type === 'behavioral' && !answer.toLowerCase().includes('situation')) {
            improvements.push('Try using the STAR method (Situation, Task, Action, Result)');
        }
        
        if (improvements.length > 0) {
            feedback += '<div class="mt-2"><strong class="text-amber-600">Suggestions:</strong><ul class="list-disc list-inside ml-2">';
            improvements.forEach(improvement => {
                feedback += `<li>${improvement}</li>`;
            });
            feedback += '</ul></div>';
        }
        
        // Overall score
        const score = Math.min(10, Math.max(4, positives.length * 2 + (answerLength > 100 ? 2 : 0)));
        feedback += `<div class="mt-2"><strong>Overall Score:</strong> <span class="font-bold text-indigo-600">${score}/10</span></div>`;
        
        feedback += '</div>';
        
        return feedback;
    }
    
    function nextPracticeQuestion() {
        if (interviewQuestions.length === 0) {
            showToast('No questions available', 'error');
            return;
        }
        
        // Find next question
        const currentIndex = interviewQuestions.findIndex(q => q.id === currentPracticeQuestion.id);
        const nextIndex = (currentIndex + 1) % interviewQuestions.length;
        const nextQuestion = interviewQuestions[nextIndex];
        
        startPracticeMode(nextQuestion);
    }
    
    // Demo function for testing without real jobs
    window.loadDemoJob = function() {
        console.log('🎯 Loading demo job for testing...');
        
        // Create a demo job
        const demoJob = {
            id: 'demo-job-1',
            company: 'TechCorp',
            position: 'Senior Data Scientist',
            jobTitle: 'Senior Data Scientist', // Alternative field name
            companyName: 'TechCorp', // Alternative field name
            jobDescription: 'We are seeking a Senior Data Scientist with expertise in Python, machine learning, and statistical analysis. The ideal candidate will have experience with large datasets, data visualization, and communicating findings to stakeholders. Knowledge of cloud platforms (AWS, GCP) and deep learning frameworks is a plus. Experience with SQL, pandas, numpy, scikit-learn, and TensorFlow/PyTorch preferred.',
            appStatus: 'Applied',
            status: 'Applied', // Alternative field name
            submissionDate: new Date().toISOString(),
            jobSource: 'LinkedIn'
        };
        
        console.log('📋 Demo job created:', demoJob);
        
        // Add to allJobs temporarily
        const originalJobs = [...allJobs];
        allJobs.push(demoJob);
        
        // Update the dropdown
        populateJobSelection();
        
        // Auto-select the demo job
        const jobSelect = document.getElementById('interview-job-select');
        if (jobSelect) {
            jobSelect.value = demoJob.id;
            
            // Trigger change event manually
            currentJobForInterview = demoJob;
            displaySelectedJobInfo(demoJob);
            document.getElementById('selected-job-info').classList.remove('hidden');
            
            showToast('Demo job loaded! Click "Generate Questions" to test the feature.', 'success');
        } else {
            console.error('❌ Job select element not found');
        }
        
        // Restore original jobs after 5 minutes
        setTimeout(() => {
            allJobs.length = 0;
            allJobs.push(...originalJobs);
            populateJobSelection();
            console.log('Demo mode ended, restored original jobs');
        }, 300000); // 5 minutes
    };
    
    async function generateTailoredResume() {
        const jobDescription = document.getElementById('job-description-input').value.trim();
        
        // Get resume content based on input type
        let currentResume = '';
        const inputType = document.querySelector('input[name="resume-input-type"]:checked').value;
        
        if (inputType === 'upload') {
            if (!extractedResumeText) {
                showToast('Please upload a PDF resume first', 'error');
                return;
            }
            currentResume = extractedResumeText;
        } else {
            currentResume = document.getElementById('current-resume-input').value.trim();
        }
        
        if (!jobDescription || !currentResume) {
            showToast('Please provide both job description and resume content', 'error');
            return;
        }
        
        const generateBtn = document.getElementById('generate-resume-btn');
        const btnText = document.getElementById('generate-btn-text');
        const btnSpinner = document.getElementById('generate-btn-spinner');
        const resultsContainer = document.getElementById('results-container');
        const outputDiv = document.getElementById('tailored-resume-output');
        
        // Update button state
        generateBtn.disabled = true;
        btnText.textContent = 'Generating...';
        btnSpinner.classList.remove('hidden');
        resultsContainer.classList.add('hidden');
        
        try {
            // Simulate AI processing with a realistic delay
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Generate tailored resume using AI prompt
            const tailoredResume = await processResumeWithAI(jobDescription, currentResume);
            
            // Display results with improved formatting
            displayFormattedResume(outputDiv, tailoredResume);
            resultsContainer.classList.remove('hidden');
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showToast('Resume successfully tailored!', 'success');
            
        } catch (error) {
            console.error('Error generating resume:', error);
            showToast('Failed to generate resume. Please try again.', 'error');
        } finally {
            // Reset button state
            generateBtn.disabled = false;
            btnText.textContent = 'Generate Tailored Resume';
            btnSpinner.classList.add('hidden');
        }
    }
    
    async function processResumeWithAI(jobDescription, currentResume) {
        // AI-powered resume tailoring logic
        const prompt = `As an expert resume writer and career consultant, please analyze the job description and tailor the provided resume to maximize the candidate's chances of getting an interview. Focus on:

1. KEYWORD OPTIMIZATION: Incorporate relevant keywords from the job description
2. SKILLS HIGHLIGHTING: Emphasize skills that match the job requirements
3. EXPERIENCE RELEVANCE: Reframe experiences to align with job needs
4. ATS OPTIMIZATION: Ensure the resume is ATS-friendly
5. IMPACT STATEMENTS: Use action verbs and quantify achievements where possible

JOB DESCRIPTION:
${jobDescription}

CURRENT RESUME:
${currentResume}

Please provide a tailored resume that:
- Maintains the candidate's authentic experience
- Highlights the most relevant qualifications
- Uses keywords from the job description naturally
- Follows a clear, professional format
- Is optimized for both ATS systems and human reviewers

TAILORED RESUME:`;
        
        // In a real implementation, you would call an AI service here
        // For demo purposes, we'll simulate intelligent resume tailoring
        return simulateAIResumeProcessing(jobDescription, currentResume);
    }
    
    function simulateAIResumeProcessing(jobDescription, currentResume) {
        // Extract key requirements from job description
        const jobKeywords = extractKeywords(jobDescription);
        
        // Enhance the resume with job-specific optimizations
        let tailoredResume = currentResume;
        
        // Add a professional summary if not present
        if (!tailoredResume.toLowerCase().includes('summary') && !tailoredResume.toLowerCase().includes('objective')) {
            const summary = generateProfessionalSummary(jobKeywords);
            tailoredResume = summary + '\n\n' + tailoredResume;
        }
        
        // Enhance skills section
        tailoredResume = enhanceSkillsSection(tailoredResume, jobKeywords);
        
        // Optimize experience descriptions
        tailoredResume = optimizeExperienceSection(tailoredResume, jobKeywords);
        
        // Add relevant keywords naturally throughout
        tailoredResume = addKeywordsNaturally(tailoredResume, jobKeywords);
        
        // Add professional polish
        tailoredResume = addProfessionalPolish(tailoredResume);
        
        return tailoredResume;
    }
    
    function extractKeywords(jobDescription) {
        // Common keywords and skills to look for
        const techSkills = ['JavaScript', 'Python', 'React', 'Node.js', 'SQL', 'AWS', 'Docker', 'Git', 'Agile', 'Scrum'];
        const softSkills = ['leadership', 'communication', 'teamwork', 'problem-solving', 'analytical', 'project management'];
        const industries = ['healthcare', 'finance', 'technology', 'marketing', 'sales', 'education'];
        
        const keywords = [];
        const lowerDesc = jobDescription.toLowerCase();
        
        // Extract technical skills
        techSkills.forEach(skill => {
            if (lowerDesc.includes(skill.toLowerCase())) {
                keywords.push(skill);
            }
        });
        
        // Extract soft skills
        softSkills.forEach(skill => {
            if (lowerDesc.includes(skill)) {
                keywords.push(skill);
            }
        });
        
        // Extract industry terms
        industries.forEach(industry => {
            if (lowerDesc.includes(industry)) {
                keywords.push(industry);
            }
        });
        
        return [...new Set(keywords)]; // Remove duplicates
    }
    
    function generateProfessionalSummary(keywords) {
        const summaries = [
            `PROFESSIONAL SUMMARY\nDynamic professional with proven expertise in ${keywords.slice(0, 3).join(', ')}. Demonstrated ability to drive results through innovative solutions and collaborative teamwork.`,
            `EXECUTIVE SUMMARY\nResults-oriented professional specializing in ${keywords.slice(0, 2).join(' and ')}. Strong track record of delivering high-quality projects and exceeding performance expectations.`,
            `PROFILE\nExperienced professional with comprehensive skills in ${keywords.slice(0, 3).join(', ')}. Committed to excellence and continuous improvement in fast-paced environments.`
        ];
        
        return summaries[Math.floor(Math.random() * summaries.length)];
    }
    
    function enhanceSkillsSection(resume, keywords) {
        // Find skills section and enhance it
        const skillsMatch = resume.match(/(SKILLS|CORE COMPETENCIES|TECHNICAL SKILLS)([\s\S]*?)(?=\n[A-Z][A-Z\s]+|$)/i);
        
        if (skillsMatch) {
            let skillsSection = skillsMatch[0];
            
            // Add relevant keywords that aren't already present
            keywords.forEach(keyword => {
                if (!skillsSection.toLowerCase().includes(keyword.toLowerCase())) {
                    skillsSection += `\n• ${keyword}`;
                }
            });
            
            return resume.replace(skillsMatch[0], skillsSection);
        }
        
        return resume;
    }
    
    function optimizeExperienceSection(resume, keywords) {
        // Enhance bullet points with action verbs and keywords
        const actionVerbs = ['Developed', 'Implemented', 'Managed', 'Led', 'Created', 'Optimized', 'Streamlined', 'Collaborated'];
        
        return resume.replace(/• ([^•\n]+)/g, (match, content) => {
            // Randomly enhance some bullet points
            if (Math.random() > 0.7 && keywords.length > 0) {
                const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
                if (!content.toLowerCase().includes(randomKeyword.toLowerCase())) {
                    return `• ${content.trim()} utilizing ${randomKeyword}`;
                }
            }
            return match;
        });
    }
    
    function addKeywordsNaturally(resume, keywords) {
        // This is a simplified version - in a real AI system, this would be more sophisticated
        return resume;
    }
    
    function addProfessionalPolish(resume) {
        // Add some professional formatting and polish
        return resume
            .replace(/\b(achieved|increased|decreased|improved)\s+(\d+%)/gi, '$1 $2')
            .replace(/\b(managed|led)\s+team/gi, 'Successfully $1 cross-functional team')
            .replace(/\b(developed|created)\s+/gi, 'Designed and $1 ');
    }
    
    function displayFormattedResume(container, resumeText) {
        // Parse and format the resume text into HTML
        const lines = resumeText.split('\n');
        let formattedHTML = '';
        let currentSection = '';
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) {
                formattedHTML += '<br>';
                return;
            }
            
            // Detect headers (all caps or specific sections)
            if (isHeader(trimmedLine)) {
                formattedHTML += `<h3 class="text-lg font-bold text-gray-800 mt-6 mb-3 border-b-2 border-indigo-200 pb-1">${trimmedLine}</h3>`;
                currentSection = trimmedLine.toLowerCase();
            }
            // Detect name (usually first line)
            else if (formattedHTML === '' || isName(trimmedLine)) {
                formattedHTML += `<h1 class="text-2xl font-bold text-gray-900 mb-2">${trimmedLine}</h1>`;
            }
            // Detect contact info
            else if (isContactInfo(trimmedLine)) {
                formattedHTML += `<p class="text-gray-600 mb-4">${trimmedLine}</p>`;
            }
            // Detect bullet points
            else if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || trimmedLine.startsWith('*')) {
                const bulletText = trimmedLine.substring(1).trim();
                formattedHTML += `<li class=\"mb-2 text-gray-700\">${bulletText}</li>`;
            }
            // Detect job titles or education entries
            else if (isJobTitle(trimmedLine) || isEducationEntry(trimmedLine)) {
                formattedHTML += `<h4 class=\"text-md font-semibold text-gray-800 mt-4 mb-2\">${trimmedLine}</h4>`;
            }
            // Regular content
            else {
                formattedHTML += `<p class=\"text-gray-700 mb-2\">${trimmedLine}</p>`;
            }
        });
        
        container.innerHTML = `<div class=\"formatted-resume\">${formattedHTML}</div>`;
    }
    
    function isHeader(line) {
        const headers = ['PROFESSIONAL SUMMARY', 'EXPERIENCE', 'EDUCATION', 'SKILLS', 'TECHNICAL SKILLS', 
                        'CORE COMPETENCIES', 'PROJECTS', 'CERTIFICATIONS', 'ACHIEVEMENTS', 'AWARDS'];
        return headers.some(header => line.toUpperCase().includes(header)) || 
               (line === line.toUpperCase() && line.length > 3 && !line.includes('@'));
    }
    
    function isName(line) {
        return !line.includes('@') && !line.includes('|') && !line.includes('(') && 
               line.split(' ').length >= 2 && line.split(' ').length <= 4;
    }
    
    function isContactInfo(line) {
        return line.includes('@') || line.includes('|') || line.includes('(') || 
               line.includes('linkedin') || line.includes('github');
    }
    
    function isJobTitle(line) {
        return line.includes(' | ') || line.includes(' at ') || line.includes(' - ') ||
               /\\d{4}/.test(line); // Contains year
    }
    
    function isEducationEntry(line) {
        return line.includes('University') || line.includes('College') || line.includes('School') ||
               line.includes('BSc') || line.includes('MSc') || line.includes('PhD') ||
               line.includes('Bachelor') || line.includes('Master') || line.includes('GPA');
    }
    
    async function copyTailoredResume() {
        const resumeContainer = document.getElementById('tailored-resume-output');
        const resumeText = resumeContainer.textContent || resumeContainer.innerText;
        
        try {
            await navigator.clipboard.writeText(resumeText);
            showToast('Resume copied to clipboard!', 'success');
        } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = resumeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Resume copied to clipboard!', 'success');
            } catch (fallbackErr) {
                showToast('Failed to copy resume', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    async function downloadTailoredResume() {
        console.log('Download button clicked!'); // Debug log
        
        const resumeContainer = document.getElementById('tailored-resume-output');
        if (!resumeContainer) {
            console.error('Resume container not found!');
            showToast('Resume container not found', 'error');
            return;
        }
        
        const resumeText = resumeContainer.textContent || resumeContainer.innerText;
        console.log('Resume text length:', resumeText.length); // Debug log
        
        if (!resumeText || resumeText.trim().length === 0) {
            console.error('No resume content found!');
            showToast('No resume content to download', 'error');
            return;
        }
        
        console.log('Calling showDownloadModal...'); // Debug log
        // Show download options modal
        showDownloadModal(resumeText);
    }
    
    function showDownloadModal(resumeText) {
        // Remove any existing modal
        const existingModal = document.getElementById('download-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Store resume text in a global variable for easy access
        window.currentResumeText = resumeText;
        
        console.log('Creating download modal...'); // Debug log
        
        // Create modal HTML
        const modalHTML = `
            <div id="download-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Download Resume</h3>
                    <p class="text-gray-600 mb-6">Choose your preferred download format:</p>
                    
                    <div class="space-y-3">
                        <button onclick="window.downloadAsPDF()" 
                            class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download as PDF (Recommended)
                        </button>
                        
                        <button onclick="window.downloadAsText()" 
                            class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download as Text File
                        </button>
                    </div>
                    
                    <button onclick="window.closeDownloadModal()" 
                        class="w-full mt-4 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        console.log('Modal created and added to page'); // Debug log
    }
    
    async function downloadAsPDF() {
        const resumeText = window.currentResumeText;
        
        if (!resumeText) {
            showToast('No resume content available', 'error');
            return;
        }
        
        try {
            // Show loading state
            const modal = document.getElementById('download-modal');
            const pdfButton = modal.querySelector('button[onclick="downloadAsPDF()"]');
            const originalHTML = pdfButton.innerHTML;
            pdfButton.disabled = true;
            pdfButton.innerHTML = `
                <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating PDF...
            `;
            
            // Load jsPDF library
            await loadJsPDF();
            
            // Create PDF with better formatting
            const { jsPDF } = window.jsPDF;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Set up page dimensions
            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 15;
            const maxWidth = pageWidth - (margin * 2);
            let yPosition = margin;
            
            // Clean and parse the resume text
            const cleanText = resumeText
                .replace(/\s+/g, ' ')
                .replace(/\n\s*\n/g, '\n')
                .trim();
            
            const lines = cleanText.split('\n').filter(line => line.trim());
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Check for page break
                if (yPosition > pageHeight - 30) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                // Format different types of content
                if (i === 0 || isName(line)) {
                    // Name - large and bold
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    yPosition += 5;
                    doc.text(line, margin, yPosition);
                    yPosition += 8;
                } else if (isContactInfo(line)) {
                    // Contact info
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(line, margin, yPosition);
                    yPosition += 5;
                } else if (isSectionHeader(line)) {
                    // Section headers
                    yPosition += 4;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(line, margin, yPosition);
                    yPosition += 6;
                } else if (line.startsWith('•')) {
                    // Bullet points
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    const bulletText = line.substring(1).trim();
                    
                    // Split long bullet points
                    const wrappedLines = doc.splitTextToSize(bulletText, maxWidth - 5);
                    doc.text('•', margin, yPosition);
                    
                    wrappedLines.forEach((wrappedLine, index) => {
                        doc.text(wrappedLine, margin + 5, yPosition + (index * 4));
                    });
                    
                    yPosition += (wrappedLines.length * 4) + 2;
                } else {
                    // Regular content
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    
                    const wrappedLines = doc.splitTextToSize(line, maxWidth);
                    wrappedLines.forEach((wrappedLine, index) => {
                        doc.text(wrappedLine, margin, yPosition + (index * 4));
                    });
                    
                    yPosition += (wrappedLines.length * 4) + 2;
                }
            }
            
            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 10);
            const filename = `tailored-resume-${timestamp}.pdf`;
            
            // Save the PDF
            doc.save(filename);
            
            closeDownloadModal();
            showToast('Resume downloaded as PDF successfully!', 'success');
            
        } catch (error) {
            console.error('PDF generation failed:', error);
            showToast('PDF generation failed. Downloading as text instead.', 'warning');
            downloadAsText();
        }
    }
    
    function downloadAsText() {
        const resumeText = window.currentResumeText;
        
        if (!resumeText) {
            showToast('No resume content available', 'error');
            return;
        }
        
        const blob = new Blob([resumeText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        const timestamp = new Date().toISOString().slice(0, 10);
        link.href = url;
        link.download = `tailored-resume-${timestamp}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        closeDownloadModal();
        showToast('Resume downloaded as text file!', 'success');
    }
    
    async function loadJsPDF() {
        return new Promise((resolve, reject) => {
            // Check if jsPDF is already loaded
            if (typeof window.jsPDF !== 'undefined') {
                resolve();
                return;
            }
            
            // Create script element
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.crossOrigin = 'anonymous';
            
            script.onload = () => {
                // Wait a moment for the library to initialize
                setTimeout(() => {
                    if (typeof window.jsPDF !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('jsPDF failed to load'));
                    }
                }, 100);
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load jsPDF library'));
            };
            
            document.head.appendChild(script);
        });
    }
    
    function isName(line) {
        // Detect if line is likely a name (first line or matches name pattern)
        return line.length < 50 && 
               line.split(' ').length >= 2 && 
               line.split(' ').length <= 4 && 
               !line.includes('@') && 
               !line.includes('|') &&
               !line.includes('(') &&
               !/\d/.test(line);
    }
    
    function closeDownloadModal() {
        const modal = document.getElementById('download-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    function isResumeHeader(line) {
        // First line with name
        return line.length < 50 && line.split(' ').length >= 2 && line.split(' ').length <= 4 && 
               !line.includes('@') && !line.includes('|');
    }
    
    function isContactInfo(line) {
        return line.includes('@') || line.includes('|') || line.includes('(') || 
               line.toLowerCase().includes('linkedin') || line.toLowerCase().includes('github');
    }
    
    function isSectionHeader(line) {
        const headers = ['PROFESSIONAL SUMMARY', 'EDUCATION', 'TECHNICAL SKILLS', 'SELECTED PROJECTS', 
                        'RELEVANT EXPERIENCE', 'CERTIFICATIONS', 'CORE COMPETENCIES', 'EXPERIENCE', 
                        'PROJECTS', 'SKILLS', 'ACHIEVEMENTS'];
        return headers.some(header => line.toUpperCase().includes(header)) || 
               (line === line.toUpperCase() && line.length > 3 && !line.includes('@'));
    }
    
    function enhanceSkillsSection(resume, keywords) {
        // Find skills section and enhance with relevant keywords
        const skillsSectionRegex = /(SKILLS|TECHNICAL SKILLS|CORE COMPETENCIES)[\s\S]*?(?=\n[A-Z]{2,}|$)/i;
        
        if (skillsSectionRegex.test(resume)) {
            return resume.replace(skillsSectionRegex, (match) => {
                const relevantKeywords = keywords.filter(keyword => 
                    !match.toLowerCase().includes(keyword.toLowerCase())
                ).slice(0, 5);
                
                if (relevantKeywords.length > 0) {
                    return match + '\n• ' + relevantKeywords.join(' • ');
                }
                return match;
            });
        } else {
            // Add skills section if not present
            const skillsSection = `\n\nCORE COMPETENCIES\n\n• ${keywords.slice(0, 8).join(' • ')}`;
            return resume + skillsSection;
        }
    }
    
    function optimizeExperienceSection(resume, keywords) {
        // Enhance bullet points with action verbs and keywords
        const actionVerbs = ['Developed', 'Implemented', 'Led', 'Managed', 'Optimized', 'Delivered', 'Collaborated', 'Designed', 'Enhanced', 'Streamlined'];
        
        return resume.replace(/^[\s]*[-•]\s*(.+)$/gm, (match, content) => {
            // Enhance bullet points with stronger action verbs and relevant keywords
            let enhanced = content;
            
            // Add quantifiable metrics if not present
            if (!/\d+%|\$[\d,]+|\d+ (users|clients|projects|teams)/.test(enhanced)) {
                const metrics = ['25%', '15+ projects', '$2M+', '50+ users', '10-person team'];
                const randomMetric = metrics[Math.floor(Math.random() * metrics.length)];
                enhanced += ` resulting in ${randomMetric} improvement`;
            }
            
            return '• ' + enhanced;
        });
    }
    
    function addKeywordsNaturally(resume, keywords) {
        // Strategically incorporate keywords throughout the resume
        keywords.forEach(keyword => {
            if (!resume.toLowerCase().includes(keyword.toLowerCase())) {
                // Find appropriate place to add keyword
                const experienceSection = resume.match(/EXPERIENCE[\s\S]*?(?=\n[A-Z]{2,}|$)/i);
                if (experienceSection) {
                    const insertion = `• Utilized ${keyword} to enhance operational efficiency and project delivery`;
                    resume = resume.replace(/EXPERIENCE([\s\S]*?)(?=\n[A-Z]{2,}|$)/i, 
                        `EXPERIENCE$1\n${insertion}\n`);
                }
            }
        });
        
        return resume;
    }
    
    function displayFormattedResume(container, resumeText) {
        // Parse and format the resume text into HTML
        const lines = resumeText.split('\n');
        let formattedHTML = '';
        let currentSection = '';
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) {
                formattedHTML += '<br>';
                return;
            }
            
            // Detect headers (all caps or specific sections)
            if (isHeader(trimmedLine)) {
                formattedHTML += `<h3 class="text-lg font-bold text-gray-800 mt-6 mb-3 border-b-2 border-indigo-200 pb-1">${trimmedLine}</h3>`;
                currentSection = trimmedLine.toLowerCase();
            }
            // Detect name (usually first line)
            else if (formattedHTML === '' || isName(trimmedLine)) {
                formattedHTML += `<h1 class="text-2xl font-bold text-gray-900 mb-2">${trimmedLine}</h1>`;
            }
            // Detect contact info
            else if (isContactInfo(trimmedLine)) {
                formattedHTML += `<p class="text-gray-600 mb-4">${trimmedLine}</p>`;
            }
            // Detect bullet points
            else if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || trimmedLine.startsWith('*')) {
                const bulletText = trimmedLine.substring(1).trim();
                formattedHTML += `<li class="mb-2 text-gray-700">${bulletText}</li>`;
            }
            // Detect job titles or education entries
            else if (isJobTitle(trimmedLine) || isEducationEntry(trimmedLine)) {
                formattedHTML += `<h4 class="text-md font-semibold text-gray-800 mt-4 mb-2">${trimmedLine}</h4>`;
            }
            // Regular content
            else {
                formattedHTML += `<p class="text-gray-700 mb-2">${trimmedLine}</p>`;
            }
        });
        
        container.innerHTML = `<div class="formatted-resume">${formattedHTML}</div>`;
    }
    
    function isHeader(line) {
        const headers = ['PROFESSIONAL SUMMARY', 'EXPERIENCE', 'EDUCATION', 'SKILLS', 'TECHNICAL SKILLS', 
                        'CORE COMPETENCIES', 'PROJECTS', 'CERTIFICATIONS', 'ACHIEVEMENTS', 'AWARDS'];
        return headers.some(header => line.toUpperCase().includes(header)) || 
               (line === line.toUpperCase() && line.length > 3 && !line.includes('@'));
    }
    
    function isName(line) {
        return !line.includes('@') && !line.includes('|') && !line.includes('(') && 
               line.split(' ').length >= 2 && line.split(' ').length <= 4;
    }
    
    function isContactInfo(line) {
        return line.includes('@') || line.includes('|') || line.includes('(') || 
               line.includes('linkedin') || line.includes('github');
    }
    
    function isJobTitle(line) {
        return line.includes(' | ') || line.includes(' at ') || line.includes(' - ') ||
               /\d{4}/.test(line); // Contains year
    }
    
    function isEducationEntry(line) {
        return line.includes('University') || line.includes('College') || line.includes('School') ||
               line.includes('BSc') || line.includes('MSc') || line.includes('PhD') ||
               line.includes('Bachelor') || line.includes('Master') || line.includes('GPA');
    }
    
    function copyTailoredResume() {
        const resumeContainer = document.getElementById('tailored-resume-output');
        const resumeText = resumeContainer.textContent || resumeContainer.innerText;
        
        navigator.clipboard.writeText(resumeText).then(() => {
            showToast('Resume copied to clipboard!', 'success');
            
            // Visual feedback
            const copyBtn = document.getElementById('copy-resume-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Copied!';
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
            }, 2000);
        }).catch(() => {
            showToast('Failed to copy to clipboard', 'error');
        });
    }
    
    function downloadTailoredResume() {
        const resumeContainer = document.getElementById('tailored-resume-output');
        const resumeText = resumeContainer.textContent || resumeContainer.innerText;
        const blob = new Blob([resumeText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        const timestamp = new Date().toISOString().slice(0, 10);
        link.href = url;
        link.download = `tailored-resume-${timestamp}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showToast('Resume downloaded!', 'success');
    }
    
    function downloadICSFile(eventDetailsEncoded, jobDataEncoded) {
        const eventDetails = JSON.parse(decodeURIComponent(eventDetailsEncoded));
        const jobData = JSON.parse(decodeURIComponent(jobDataEncoded));
        
        const icsContent = createICSContent(eventDetails, jobData);
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `interview-${jobData.company.replace(/\s+/g, '-').toLowerCase()}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showToast('Calendar file downloaded! Import it to your calendar app.', 'success');
    }
    
    function createICSContent(eventDetails, jobData) {
        const now = new Date().toISOString().replace(/[:-]/g, '').split('.')[0] + 'Z';
        const uid = `interview-${Date.now()}@job-os.app`;
        
        return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Job OS//Interview Scheduler//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${now}
DTSTART:${eventDetails.start}
DTEND:${eventDetails.end}
SUMMARY:${eventDetails.title}
DESCRIPTION:${eventDetails.description.replace(/\n/g, '\\n')}
LOCATION:${eventDetails.location}
BEGIN:VALARM
TRIGGER:-PT24H
ACTION:DISPLAY
DESCRIPTION:Interview Reminder: ${eventDetails.title}
END:VALARM
END:VEVENT
END:VCALENDAR`;
    }
    
    function copyEventDetails(eventDetailsEncoded) {
        const eventDetails = JSON.parse(decodeURIComponent(eventDetailsEncoded));
        const startDate = new Date(eventDetails.start.replace('Z', ''));
        
        const copyText = `📅 ${eventDetails.title}
🕒 ${startDate.toLocaleString()}
📍 ${eventDetails.location}

${eventDetails.description.replace(/\\n/g, '\n')}`;
        
        navigator.clipboard.writeText(copyText).then(() => {
            showToast('Event details copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy to clipboard', 'error');
        });
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => toast.classList.remove('translate-x-full'), 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    async function updateJobStatus(jobId, newColumn) {
        if (!userId || !jobId || !newColumn) return;
        let newStatus = 'Waiting for application response';
        if (newColumn === KANBAN_COLUMNS.INTERVIEWING) newStatus = 'First round interview';
        if (newColumn === KANBAN_COLUMNS.OFFER) newStatus = 'I accepted their offer';
        if (newColumn === KANBAN_COLUMNS.CLOSED) newStatus = 'Position was filled before I interviewed';
        
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('jobs').doc(jobId);
        try {
            await ref.update({ appStatus: newStatus });
        } catch (e) {
            console.error("Error updating job status: ", e);
        }
    }

    async function saveJob(event) {
        event.preventDefault();
        if (!userId) return;

        const submitButton = jobForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';

        const data = {
            company: document.getElementById('j-company').value, positionTitle: document.getElementById('j-positionTitle').value,
            submissionDate: document.getElementById('j-submissionDate').value, employmentType: document.getElementById('j-employmentType').value,
            appStatus: document.getElementById('j-appStatus').value, qualificationLevel: document.getElementById('j-qualificationLevel').value,
            interestLevel: document.getElementById('j-interestLevel').value, salary: document.getElementById('j-salary').value,
            foundVia: document.getElementById('j-foundVia').value, reqLink: document.getElementById('j-reqLink').value,
            notes: document.getElementById('j-notes').value, description: document.getElementById('j-description').value,
            // Calendar Integration Fields
            interviewDate: document.getElementById('j-interviewDate').value,
            interviewType: document.getElementById('j-interviewType').value,
            interviewLocation: document.getElementById('j-interviewLocation').value,
            interviewer: document.getElementById('j-interviewer').value,
            createCalendarEvent: document.getElementById('j-createCalendarEvent').checked
        };
        
        const id = jobIdField.value;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('jobs');
        let docRef;

        try {
            if (id) {
                docRef = ref.doc(id);
                await docRef.set(data, { merge: true });
            } else {
                docRef = await ref.add(data);
            }
            
            // Create calendar event if interview date is provided
            if (data.interviewDate && data.createCalendarEvent) {
                createCalendarEvent(data);
            }
        } catch (e) {
            console.error("Error saving job data:", e);
            submitButton.disabled = false;
            submitButton.textContent = 'Save Application';
            return;
        }

        const jobId = docRef.id;
        const uploadPromises = [];
        const fileDataToUpdate = {};

        const resumeFile = document.getElementById('j-resume').files[0];
        if (resumeFile) {
            const resumePath = `users/${userId}/jobs/${jobId}/resume_${Date.now()}_${resumeFile.name}`;
            const resumeRef = storage.ref(resumePath);
            uploadPromises.push(
                resumeRef.put(resumeFile).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
                    fileDataToUpdate.resumeUrl = url;
                })
            );
        }

        const coverLetterFile = document.getElementById('j-coverLetter').files[0];
        if (coverLetterFile) {
            const coverLetterPath = `users/${userId}/jobs/${jobId}/coverLetter_${Date.now()}_${coverLetterFile.name}`;
            const coverLetterRef = storage.ref(coverLetterPath);
            uploadPromises.push(
                coverLetterRef.put(coverLetterFile).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
                    fileDataToUpdate.coverLetterUrl = url;
                })
            );
        }

        try {
            await Promise.all(uploadPromises);
            if (Object.keys(fileDataToUpdate).length > 0) {
                await docRef.update(fileDataToUpdate);
            }
            closeJobModal();
        } catch (e) {
            console.error("Error uploading files or updating doc:", e);
        } finally {
             submitButton.disabled = false;
             submitButton.textContent = 'Save Application';
        }
    }

    async function saveContact(event) {
        event.preventDefault();
        if (!userId) return;
        const data = {
            name: document.getElementById('name').value, company: document.getElementById('company').value, type: document.getElementById('type').value,
            isReference: document.getElementById('is-reference').value, relationshipStanding: document.getElementById('relationship-standing').value,
            contactInfo: document.getElementById('contact-info').value, lastCommDate: document.getElementById('last-comm-date').value,
            lastCommMethod: document.getElementById('last-comm-method').value, howWeMet: document.getElementById('how-we-met').value,
            whenWeMet: document.getElementById('when-we-met').value, notes: document.getElementById('notes').value,
            email: document.getElementById('email').value, phone: document.getElementById('phone').value,
        };
        const id = contactIdField.value;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('contacts');
        try {
            if (id) await ref.doc(id).update(data);
            else await ref.add(data);
            closeModal();
        } catch (e) { console.error("Error saving contact: ", e); }
    }

    async function saveHistory(event) {
        event.preventDefault();
        if (!userId) return;
        const data = {
            company: document.getElementById('h-company').value, address: document.getElementById('h-address').value,
            startPosition: document.getElementById('h-startPosition').value, endPosition: document.getElementById('h-endPosition').value,
            startDate: document.getElementById('h-startDate').value, endDate: document.getElementById('h-endDate').value,
            startBase: document.getElementById('h-startBase').value, endBase: document.getElementById('h-endBase').value,
            bonus: document.getElementById('h-bonus').value, reason: document.getElementById('h-reason').value,
            verification: document.getElementById('h-verification').value, employmentType: document.getElementById('h-employmentType').value,
            manager: document.getElementById('h-manager').value,
        };
        const id = historyIdField.value;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('history');
        try {
            if (id) await ref.doc(id).update(data);
            else await ref.add(data);
            closeHistoryModal();
        } catch (e) { console.error("Error saving job history:", e); }
    }

     async function handleJobTableClick(event) {
        const target = event.target.closest('button');
        if (!target) return;
        
        const id = target.dataset.id;
        if (!id || !userId) return;
        
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('jobs').doc(id);
        if (target.classList.contains('job-edit-btn')) {
            const doc = await ref.get();
            if (doc.exists) openJobModal({ id: doc.id, ...doc.data() });
        }
        if (target.classList.contains('job-delete-btn')) {
            await ref.delete();
        }
    }
    
    async function handleTableClick(event) {
        const target = event.target;
        const id = target.dataset.id;
        if (!id || !userId) return;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('contacts').doc(id);
        if (target.classList.contains('edit-btn')) {
            const doc = await ref.get();
            if (doc.exists) openModal({ id: doc.id, ...doc.data() });
        }
        if (target.classList.contains('delete-btn')) {
            await ref.delete();
        }
    }

    async function handleHistoryTableClick(event) {
        const target = event.target;
        const id = target.dataset.id;
        if (!id || !userId) return;
        const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('history').doc(id);
        if (target.classList.contains('history-edit-btn')) {
            const doc = await ref.get();
            if (doc.exists) openHistoryModal({ id: doc.id, ...doc.data() });
        }
        if (target.classList.contains('history-delete-btn')) {
            await ref.delete();
        }
    }

    viewTableBtn.addEventListener('click', () => {
        jobsTableView.classList.remove('hidden');
        jobsBoardView.classList.add('hidden');
        viewTableBtn.classList.add('bg-white', 'text-indigo-600', 'shadow');
        viewBoardBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
    });

    viewBoardBtn.addEventListener('click', () => {
        jobsTableView.classList.add('hidden');
        jobsBoardView.classList.remove('hidden');
        viewBoardBtn.classList.add('bg-white', 'text-indigo-600', 'shadow');
        viewTableBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
    });

    kanbanBoard.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-card')) {
            draggedJobId = e.target.dataset.id;
            e.target.classList.add('dragging');
        }
    });

    kanbanBoard.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('kanban-card')) {
            draggedJobId = null;
            e.target.classList.remove('dragging');
        }
    });
    
    kanbanBoard.addEventListener('dragover', (e) => {
        e.preventDefault();
        const column = e.target.closest('.kanban-column');
        if (column) {
            column.classList.add('drag-over');
        }
    });

    kanbanBoard.addEventListener('dragleave', (e) => {
        const column = e.target.closest('.kanban-column');
        if (column) {
            column.classList.remove('drag-over');
        }
    });
    
    kanbanBoard.addEventListener('drop', (e) => {
        e.preventDefault();
        const column = e.target.closest('.kanban-column');
        if (column && draggedJobId) {
            column.classList.remove('drag-over');
            const newStatus = column.dataset.columnName;
            updateJobStatus(draggedJobId, newStatus);
        }
    });

    addJobBtn.addEventListener('click', () => openJobModal());
    jobCancelBtn.addEventListener('click', closeJobModal);
    jobForm.addEventListener('submit', saveJob);
    jobsTableContainer.addEventListener('click', handleJobTableClick);

    addContactBtn.addEventListener('click', () => openModal());
    cancelBtn.addEventListener('click', closeModal);
    contactForm.addEventListener('submit', saveContact);
    networkTableContainer.addEventListener('click', handleTableClick);

    addHistoryBtn.addEventListener('click', () => openHistoryModal());
    historyCancelBtn.addEventListener('click', closeHistoryModal);
    historyForm.addEventListener('submit', saveHistory);
    historyTableContainer.addEventListener('click', handleHistoryTableClick);
    
    // Task Management Event Listeners
    addTaskBtn.addEventListener('click', () => openTaskModal());
    taskCancelBtn.addEventListener('click', closeTaskModal);
    taskForm.addEventListener('submit', saveTask);
    tasksContainer.addEventListener('click', handleTaskAction);
    
    // Smart Resume Event Listeners
    document.getElementById('generate-resume-btn').addEventListener('click', generateTailoredResume);
    document.getElementById('copy-resume-btn').addEventListener('click', copyTailoredResume);
    document.getElementById('download-resume-btn').addEventListener('click', downloadTailoredResume);

    navTabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab)));
    
    function cleanupAutoTasks(currentJobs) {
        // Remove auto-generated tasks that are no longer relevant
        allTasks.filter(task => task.isAutoGenerated && !task.completed).forEach(task => {
            let shouldDelete = false;
            
            if (task.relatedJobId) {
                const relatedJob = currentJobs.find(job => job.id === task.relatedJobId);
                
                if (!relatedJob) {
                    shouldDelete = true; // Job was deleted
                } else {
                    // Check if task is still relevant based on job status
                    if (task.type === 'auto-followup' && relatedJob.appStatus !== 'Waiting for application response') {
                        shouldDelete = true;
                    }
                    if (task.type === 'auto-interview-prep' && !relatedJob.appStatus.toLowerCase().includes('interview')) {
                        shouldDelete = true;
                    }
                    if (task.type === 'auto-thank-you' && (!relatedJob.appStatus.includes('round interview') && !relatedJob.appStatus.includes('interview then'))) {
                        shouldDelete = true;
                    }
                }
            }
            
            if (shouldDelete) {
                const ref = db.collection('artifacts').doc('job-os-app').collection('users').doc(userId).collection('tasks');
                ref.doc(task.id).delete().catch(e => console.error("Error deleting auto task: ", e));
            }
        });
    }
    
        // ========================================================================================
        // COVER LETTER GENERATOR
        // ========================================================================================
        
        // Cover Letter Generator state
        let currentCoverLetter = '';
        let coverLetterResumeText = ''; // Separate resume text for cover letter
        let coverUploadedResumeFile = null;
        
        // Initialize Cover Letter functionality
        function initializeCoverLetter() {
            console.log('🎯 Initializing Cover Letter Generator...');
            
            // Check if Cover Letter elements exist
            const generateBtn = document.getElementById('generate-cover-letter-btn');
            const resumeInput = document.getElementById('cover-resume-pdf-input');
            
            if (!generateBtn) {
                console.log('Cover Letter elements not found, skipping initialization');
                return;
            }
            
            console.log('Cover Letter elements found, setting up handlers');
            
            // Setup resume input type handlers
            initializeCoverResumeInputHandlers();
            
            // Event listeners with error checking
            const elements = [
                { id: 'generate-cover-letter-btn', handler: generateNewCoverLetter, event: 'click' },
                { id: 'edit-cover-letter-btn', handler: enterEditMode, event: 'click' },
                { id: 'cancel-edit-btn', handler: cancelEditMode, event: 'click' },
                { id: 'save-edit-btn', handler: saveEditChanges, event: 'click' },
                { id: 'copy-cover-letter-btn', handler: copyCoverLetter, event: 'click' },
                { id: 'download-cover-letter-btn', handler: downloadCoverLetter, event: 'click' }
            ];
            
            elements.forEach(({ id, handler, event }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                    element.setAttribute('data-listener-attached', 'true');
                    console.log(`✅ Event listener added for ${id}`);
                } else {
                    console.warn(`⚠️ Element not found: ${id}`);
                }
            });
        }
        
        // Initialize cover letter resume input handlers
        function initializeCoverResumeInputHandlers() {
            const radioButtons = document.querySelectorAll('input[name="cover-resume-input-type"]');
            const uploadSection = document.getElementById('cover-resume-upload-section');
            const textSection = document.getElementById('cover-resume-text-section');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'upload') {
                        uploadSection.classList.remove('hidden');
                        textSection.classList.add('hidden');
                    } else {
                        uploadSection.classList.add('hidden');
                        textSection.classList.remove('hidden');
                    }
                });
            });
            
            // File upload handling
            const fileInput = document.getElementById('cover-resume-pdf-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleCoverResumeFileUpload);
            }
        }
        
        // Handle cover letter resume file upload
        function handleCoverResumeFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showToast('Please upload a PDF file only', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showToast('File size must be less than 10MB', 'error');
                return;
            }
            
            coverUploadedResumeFile = file;
            
            // Show file info
            document.getElementById('cover-upload-area').classList.add('hidden');
            const fileInfo = document.getElementById('cover-uploaded-file-info');
            document.getElementById('cover-file-name').textContent = file.name;
            fileInfo.classList.remove('hidden');
            
            // Extract text from PDF
            extractCoverResumeText(file);
        }
        
        // Extract text from cover letter resume PDF
        async function extractCoverResumeText(file) {
            showToast('Extracting text from PDF...', 'info');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const typedarray = new Uint8Array(arrayBuffer);
                await processCoverResumePDF(typedarray, file.name);
            } catch (error) {
                console.error('Error reading PDF file:', error);
                showToast('Error reading PDF file', 'error');
            }
        }
        
        // Process cover letter resume PDF  
        async function processCoverResumePDF(typedarray, originalFileName) {
            try {
                // Check if PDF.js is available, load if needed
                if (typeof pdfjsLib === 'undefined') {
                    console.log('Loading PDF.js library...');
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            resolve();
                        };
                        script.onerror = reject;
                    });
                }
                
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = '';
                
                // Extract text from all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    // Combine text items with proper spacing
                    const pageText = textContent.items
                        .map(item => item.str)
                        .join(' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    if (pageText) {
                        fullText += pageText + '\n\n';
                    }
                }
                
                if (fullText.trim()) {
                    coverLetterResumeText = fullText.trim();
                    showToast('Resume text extracted successfully!', 'success');
                    console.log('Cover letter resume extracted, length:', coverLetterResumeText.length);
                } else {
                    showToast('Could not extract text from PDF. Please use "Paste Text" option instead.', 'warning');
                }
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                showToast('Could not extract text from PDF. Please use "Paste Text" option instead.', 'warning');
            }
        }
        
        // Clear uploaded cover letter resume file
        function clearCoverUploadedFile() {
            coverUploadedResumeFile = null;
            coverLetterResumeText = '';
            const fileInput = document.getElementById('cover-resume-pdf-input');
            const uploadArea = document.getElementById('cover-upload-area');
            const fileInfo = document.getElementById('cover-uploaded-file-info');
            
            if (fileInput) fileInput.value = '';
            if (uploadArea) uploadArea.classList.remove('hidden');
            if (fileInfo) fileInfo.classList.add('hidden');
            
            showToast('Resume cleared', 'info');
        }
        
        // Generate cover letter using new self-contained approach
        async function generateNewCoverLetter() {
            console.log('🤖 Generate Cover Letter button clicked!');
            
            // Get job details from form
            const jobTitle = document.getElementById('cover-job-title').value.trim();
            const companyName = document.getElementById('cover-company-name').value.trim();
            const jobDescription = document.getElementById('cover-job-description').value.trim();
            
            // Validate required fields
            if (!jobTitle || !companyName) {
                showToast('Please enter job title and company name', 'error');
                return;
            }
            
            // Get resume content
            const resumeContent = getCoverLetterResumeContent();
            if (!resumeContent) {
                showToast('Please upload your resume or paste resume text', 'error');
                return;
            }
            
            console.log('✅ Job Details - Title:', jobTitle, 'Company:', companyName);
            console.log('✅ Resume content length:', resumeContent.length);
            
            const generateBtn = document.getElementById('generate-cover-letter-btn');
            const generateText = document.getElementById('generate-cover-letter-text');
            const generateSpinner = document.getElementById('generate-cover-letter-spinner');
            
            // Show loading state
            generateBtn.disabled = true;
            if (generateText) generateText.textContent = 'Generating...';
            if (generateSpinner) generateSpinner.classList.remove('hidden');
            
            try {
                // Get user preferences
                const tone = document.getElementById('cover-letter-tone').value;
                const length = document.getElementById('cover-letter-length').value;
                const focusAreas = getFocusAreas();
                
                console.log('📋 Settings - Tone:', tone, 'Length:', length, 'Focus:', focusAreas);
                
                showToast('Creating personalized cover letter with your resume data...', 'info');
                
                // Simulate AI generation
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                // Create job object for generation
                const jobData = {
                    position: jobTitle,
                    company: companyName,
                    description: jobDescription
                };
                
                const coverLetter = generatePersonalizedCoverLetter(jobData, resumeContent, tone, length, focusAreas);
                
                console.log('✅ Cover letter generated, length:', coverLetter.length);
                
                // Display the generated cover letter
                displayCoverLetter(coverLetter, jobData);
                
                showToast('Cover letter generated successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Error generating cover letter:', error);
                showToast('Failed to generate cover letter. Please try again.', 'error');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                if (generateText) generateText.textContent = 'Generate Cover Letter';
                if (generateSpinner) generateSpinner.classList.add('hidden');
            }
        }
        
        // Get current resume content for cover letter
        function getCoverLetterResumeContent() {
            console.log('🔍 Checking for cover letter resume content...');
            
            // Check if user has uploaded a PDF resume for cover letter
            if (coverLetterResumeText && coverLetterResumeText.trim()) {
                console.log('✅ Using cover letter PDF resume content');
                return coverLetterResumeText;
            }
            
            // Check if user has entered text resume for cover letter
            const textInput = document.getElementById('cover-current-resume-input');
            if (textInput && textInput.value.trim()) {
                console.log('✅ Using cover letter text input resume content');
                return textInput.value.trim();
            }
            
            console.log('❌ No cover letter resume content found');
            return null;
        }
        
        // Generate personalized cover letter with resume data
        function generatePersonalizedCoverLetter(jobData, resumeContent, tone, length, focusAreas) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Extract key information
            const position = jobData.position || 'the position';
            const company = jobData.company || 'your company';
            const jobDescription = jobData.description || '';
            
            // Extract user's name from resume
            const userName = extractNameFromResume(resumeContent);
            console.log('🗃️ Using name:', userName);
            
            // CRITICAL DEBUG: Show exactly what resume content we're working with
            console.log('🚨 RESUME CONTENT DEBUG:');
            console.log('🚨 Resume content type:', typeof resumeContent);
            console.log('🚨 Resume content is null/undefined:', resumeContent == null);
            console.log('🚨 Resume content length:', resumeContent ? resumeContent.length : 'N/A');
            if (resumeContent) {
                console.log('🚨 First 300 characters:', resumeContent.substring(0, 300));
                console.log('🚨 First 5 lines:', resumeContent.split('\\n').slice(0, 5));
            }
            
            // Analyze job description for keywords
            const keywords = extractKeywords(jobDescription);
            console.log('🔑 Extracted keywords:', keywords);
            
            // Extract relevant data from resume
            const relevantExperience = extractRelevantExperience(resumeContent, keywords);
            const userSkills = extractSkillsFromResume(resumeContent);
            
            console.log('📋 Extracted experience points:', relevantExperience.length, relevantExperience);
            console.log('🛠️ Extracted skills:', userSkills.length, userSkills);
            
            // Add extra debug for resume content
            console.log('📄 First 500 chars of resume:', resumeContent.substring(0, 500));
            console.log('📄 Resume lines count:', resumeContent.split('\n').length);
            
            // Generate personalized content
            const intro = generateIntro(position, company, tone);
            const body = generateBody(position, company, jobDescription, keywords, focusAreas, tone, length, relevantExperience, userSkills);
            const closing = generateClosing(tone);
            
            return `${currentDate}\n\nDear Hiring Manager,\n\n${intro}\n\n${body}\n\n${closing}\n\nSincerely,\n${userName}`;
        }
        
        // Populate job selection dropdown
        function populateCoverLetterJobSelect() {
            const select = document.getElementById('cover-letter-job-select');
            
            console.log('Populating cover letter job selection, available jobs:', allJobs.length);
            
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Check if there are any jobs
            if (!allJobs || allJobs.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No job applications found. Add jobs in Job Tracker first.';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            allJobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                // Try multiple possible field names for position and company
                const position = job.position || job.positionTitle || job.title || job.role || job.jobTitle || 'Untitled';
                const company = job.company || job.companyName || job.employer || 'Unknown Company';
                option.textContent = `${position} at ${company}`;
                select.appendChild(option);
            });
        }
        
        // Handle job selection
        function onCoverLetterJobSelect(event) {
            const jobId = event.target.value;
            const jobInfo = document.getElementById('cover-letter-job-info');
            
            if (!jobId) {
                jobInfo.classList.add('hidden');
                currentJobForCoverLetter = null;
                return;
            }
            
            const job = allJobs.find(j => j.id === jobId);
            
            if (job) {
                currentJobForCoverLetter = job;
                
                // Update job info display with multiple field name fallbacks
                const position = job.position || job.positionTitle || job.title || job.role || job.jobTitle || 'Untitled Position';
                const company = job.company || job.companyName || job.employer || 'Unknown Company';
                const status = job.status || job.appStatus || 'Unknown';
                
                document.getElementById('cover-letter-job-title').textContent = position;
                document.getElementById('cover-letter-job-company').textContent = company;
                
                const statusSpan = document.getElementById('cover-letter-job-status');
                statusSpan.textContent = status;
                statusSpan.className = `inline-block px-2 py-1 text-xs rounded-full mt-2 ${getStatusColor(status)}`;
                
                jobInfo.classList.remove('hidden');
            }
        }
        
        // Generate cover letter using new self-contained approach
        async function generateNewCoverLetter() {
            console.log('🤖 Generate Cover Letter button clicked!');
            
            // Get job details from form
            const jobTitle = document.getElementById('cover-job-title').value.trim();
            const companyName = document.getElementById('cover-company-name').value.trim();
            const jobDescription = document.getElementById('cover-job-description').value.trim();
            
            // Validate required fields
            if (!jobTitle || !companyName) {
                showToast('Please enter job title and company name', 'error');
                return;
            }
            
            // Get resume content
            const resumeContent = getCoverLetterResumeContent();
            if (!resumeContent) {
                showToast('Please upload your resume or paste resume text', 'error');
                return;
            }
            
            console.log('✅ Job Details - Title:', jobTitle, 'Company:', companyName);
            console.log('✅ Resume content length:', resumeContent.length);
            
            const generateBtn = document.getElementById('generate-cover-letter-btn');
            const generateText = document.getElementById('generate-cover-letter-text');
            const generateSpinner = document.getElementById('generate-cover-letter-spinner');
            
            // Show loading state
            generateBtn.disabled = true;
            if (generateText) generateText.textContent = 'Generating...';
            if (generateSpinner) generateSpinner.classList.remove('hidden');
            
            try {
                // Get user preferences
                const tone = document.getElementById('cover-letter-tone').value;
                const length = document.getElementById('cover-letter-length').value;
                const focusAreas = getFocusAreas();
                
                console.log('📋 Settings - Tone:', tone, 'Length:', length, 'Focus:', focusAreas);
                
                showToast('Creating personalized cover letter with your resume data...', 'info');
                
                // Simulate AI generation
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                // Create job object for generation
                const jobData = {
                    position: jobTitle,
                    company: companyName,
                    description: jobDescription
                };
                
                const coverLetter = generatePersonalizedCoverLetter(jobData, resumeContent, tone, length, focusAreas);
                
                console.log('✅ Cover letter generated, length:', coverLetter.length);
                
                // Display the generated cover letter
                displayCoverLetter(coverLetter, jobData);
                
                showToast('Cover letter generated successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Error generating cover letter:', error);
                showToast('Failed to generate cover letter. Please try again.', 'error');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                if (generateText) generateText.textContent = 'Generate Cover Letter';
                if (generateSpinner) generateSpinner.classList.add('hidden');
            }
        }
        
        // Get selected focus areas
        function getFocusAreas() {
            const focusAreas = [];
            if (document.getElementById('focus-experience').checked) focusAreas.push('experience');
            if (document.getElementById('focus-skills').checked) focusAreas.push('skills');
            if (document.getElementById('focus-passion').checked) focusAreas.push('passion');
            if (document.getElementById('focus-achievements').checked) focusAreas.push('achievements');
            return focusAreas;
        }
        
        // Get current resume content for cover letter
        function getCoverLetterResumeContent() {
            console.log('🔍 Checking for cover letter resume content...');
            
            // Check if user has uploaded a PDF resume for cover letter
            if (coverLetterResumeText && coverLetterResumeText.trim()) {
                console.log('✅ Using cover letter PDF resume content');
                return coverLetterResumeText;
            }
            
            // Check if user has entered text resume for cover letter
            const textInput = document.getElementById('cover-current-resume-input');
            if (textInput && textInput.value.trim()) {
                console.log('✅ Using cover letter text input resume content');
                return textInput.value.trim();
            }
            
            console.log('❌ No cover letter resume content found');
            return null;
        }
        function getCurrentResumeContent() {
            console.log('🔍 Checking for resume content...');
            console.log('📄 extractedResumeText available:', !!extractedResumeText);
            console.log('📄 extractedResumeText length:', extractedResumeText ? extractedResumeText.length : 0);
            
            // Check if user has uploaded a PDF resume
            if (extractedResumeText && extractedResumeText.trim()) {
                console.log('✅ Using extracted PDF resume content');
                console.log('📄 First 200 chars:', extractedResumeText.substring(0, 200));
                return extractedResumeText;
            }
            
            // Check if user has entered text resume
            const textInput = document.getElementById('current-resume-input');
            console.log('📝 Text input element found:', !!textInput);
            if (textInput && textInput.value.trim()) {
                console.log('✅ Using text input resume content');
                console.log('📝 Text input length:', textInput.value.trim().length);
                console.log('📝 First 200 chars:', textInput.value.trim().substring(0, 200));
                return textInput.value.trim();
            }
            
            console.log('❌ No resume content found');
            return null;
        }
        
        // Extract relevant experience from resume for cover letter
        function extractRelevantExperience(resumeContent, keywords) {
            if (!resumeContent) {
                console.log('❌ No resume content provided to extractRelevantExperience');
                return [];
            }
            
            console.log('🔍 Analyzing resume content for experience (length:', resumeContent.length, ')');
            console.log('🔍 Looking for keywords:', keywords);
            
            const lines = resumeContent.split('\n');
            const relevantExperience = [];
            let inExperienceSection = false;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // Check if we're in experience section
                if (trimmedLine.toUpperCase().includes('EXPERIENCE') && 
                    !trimmedLine.toUpperCase().includes('YEARS OF EXPERIENCE')) {
                    inExperienceSection = true;
                    console.log('📋 Found experience section at line', index + 1, ':', trimmedLine);
                    return;
                }
                
                // Check if we've moved to another section
                if (inExperienceSection && (trimmedLine.toUpperCase().includes('EDUCATION') ||
                    trimmedLine.toUpperCase().includes('SKILLS') ||
                    trimmedLine.toUpperCase().includes('CERTIFICATIONS') ||
                    trimmedLine.toUpperCase().includes('REFERENCES'))) {
                    console.log('📋 Leaving experience section at line', index + 1, ':', trimmedLine);
                    inExperienceSection = false;
                    return;
                }
                
                // Extract relevant bullet points from experience
                if (inExperienceSection && (trimmedLine.startsWith('●') || trimmedLine.startsWith('•') || trimmedLine.startsWith('-'))) {
                    const cleanedExperience = trimmedLine.replace(/^[●•\-]\s*/, '');
                    
                    // Check if this experience point contains relevant keywords or is accounting-related
                    const hasRelevantKeyword = keywords.length === 0 || keywords.some(keyword => 
                        cleanedExperience.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    // Always include accounting/finance-related experience
                    const isAccountingRelated = cleanedExperience.toLowerCase().includes('accounting') ||
                                               cleanedExperience.toLowerCase().includes('payroll') ||
                                               cleanedExperience.toLowerCase().includes('payable') ||
                                               cleanedExperience.toLowerCase().includes('receivable') ||
                                               cleanedExperience.toLowerCase().includes('financial') ||
                                               cleanedExperience.toLowerCase().includes('tax') ||
                                               cleanedExperience.toLowerCase().includes('reconciliation') ||
                                               cleanedExperience.toLowerCase().includes('quickbooks') ||
                                               cleanedExperience.toLowerCase().includes('invoice');
                    
                    if (hasRelevantKeyword || isAccountingRelated || relevantExperience.length < 4) {
                        relevantExperience.push(cleanedExperience);
                        console.log('✅ Added experience:', cleanedExperience.substring(0, 60) + '...');
                    }
                }
            });
            
            console.log('📋 Total experience points extracted:', relevantExperience.length);
            return relevantExperience.slice(0, 4); // Return top 4 relevant experiences
        }
        
        // Extract user's name from resume
        function extractNameFromResume(resumeContent) {
            if (!resumeContent) return '[Your Name]';
            
            const lines = resumeContent.split('\n');
            
            // Look for the first line that looks like a name
            for (let i = 0; i < Math.min(10, lines.length); i++) {
                const line = lines[i].trim();
                
                // Skip empty lines
                if (!line) continue;
                
                // Check if this line contains contact info - if so, extract name from it
                if (line.includes('@') || line.includes('|') || line.includes('(')) {
                    // Try to extract name from contact line like "Ibrahim Denis Fofanah Somerset, NJ | (732) 318 9987"
                    const parts = line.split(/[|@(]/);
                    if (parts.length > 0) {
                        const namePart = parts[0].trim();
                        const words = namePart.split(/\s+/);
                        if (words.length >= 2 && words.length <= 4 && namePart.length < 50) {
                            console.log('🗃️ Extracted name from contact line:', namePart);
                            return namePart;
                        }
                    }
                    continue;
                }
                
                // Check if line looks like a standalone name (2-4 words, no numbers, reasonable length)
                const words = line.split(/\s+/);
                if (words.length >= 2 && words.length <= 4 && 
                    line.length < 50 && 
                    !line.toLowerCase().includes('summary') && 
                    !line.toLowerCase().includes('profile') &&
                    !line.toLowerCase().includes('education') &&
                    !/\d/.test(line)) {
                    console.log('�️ Extracted name:', line);
                    return line;
                }
            }
            
            console.log('�️ Could not extract name from resume');
            return '[Your Name]';
        }
        function extractSkillsFromResume(resumeContent) {
            if (!resumeContent) {
                console.log('❌ No resume content provided to extractSkillsFromResume');
                return [];
            }
            
            console.log('🔍 Analyzing resume content for skills (length:', resumeContent.length, ')');
            
            const lines = resumeContent.split('\n');
            const skills = [];
            let inSkillsSection = false;
            let skillsHeaderFound = false;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // Check if we're in skills section - handle "Skills & Certifications" or "Technical Skills"
                if (trimmedLine.toUpperCase().includes('SKILLS') || 
                    trimmedLine.toUpperCase().includes('TECHNICAL SKILLS') ||
                    trimmedLine.toUpperCase().includes('COMPETENCIES') ||
                    trimmedLine.toUpperCase().includes('TECHNOLOGIES')) {
                    skillsHeaderFound = true;
                    console.log('🛠️ Found skills header at line', index + 1, ':', trimmedLine);
                }
                
                // Look for "Technical Skills" subsection specifically
                if (skillsHeaderFound && trimmedLine.toUpperCase().includes('TECHNICAL SKILLS')) {
                    inSkillsSection = true;
                    console.log('🛠️ Entering technical skills section at line', index + 1, ':', trimmedLine);
                    return;
                }
                
                // Check if we've moved to another section after skills
                if (inSkillsSection && (trimmedLine.toUpperCase().includes('PROFESSIONAL COMPETENCIES') ||
                    trimmedLine.toUpperCase().includes('CERTIFICATIONS') ||
                    trimmedLine.toUpperCase().includes('REFERENCES') ||
                    trimmedLine.toUpperCase().includes('EDUCATION') ||
                    trimmedLine.toUpperCase().includes('EXPERIENCE'))) {
                    console.log('🛠️ Leaving skills section at line', index + 1, ':', trimmedLine);
                    inSkillsSection = false;
                    return;
                }
                
                // Extract skills - handle bullet points
                if (inSkillsSection && (trimmedLine.startsWith('●') || trimmedLine.startsWith('•') || trimmedLine.startsWith('-'))) {
                    let skillLine = trimmedLine.replace(/^[●•\-]\s*/, '');
                    
                    // Clean up the skill name (remove extra text)
                    skillLine = skillLine.trim();
                    
                    if (skillLine.length > 1) {
                        skills.push(skillLine);
                        console.log('✅ Added skill:', skillLine);
                    }
                }
            });
            
            // Remove duplicates and clean up
            const uniqueSkills = [...new Set(skills)].filter(skill => 
                skill.length > 1 && !skill.toLowerCase().includes('&')
            ).map(skill => skill.trim());
            
            console.log('🛠️ Total skills extracted:', uniqueSkills.length, uniqueSkills);
            return uniqueSkills.slice(0, 8); // Return top 8 skills
        }
        function generateSmartCoverLetter(job, tone, length, focusAreas) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Extract key information with field name fallbacks
            const position = job.position || job.positionTitle || job.title || job.role || job.jobTitle || 'the position';
            const company = job.company || job.companyName || job.employer || 'your company';
            const jobDescription = job.description || job.jobDescription || job.details || job.requirements || '';
            
            // Get current resume content
            const resumeContent = getCurrentResumeContent();
            console.log('Resume content available:', !!resumeContent);
            
            // Analyze job description for keywords
            const keywords = extractKeywords(jobDescription);
            
            // Extract relevant data from resume if available
            let relevantExperience = [];
            let userSkills = [];
            
            if (resumeContent) {
                console.log('📋 Extracting data from resume...');
                relevantExperience = extractRelevantExperience(resumeContent, keywords);
                userSkills = extractSkillsFromResume(resumeContent);
                console.log('✅ Extracted experience points:', relevantExperience.length, relevantExperience);
                console.log('✅ Extracted skills:', userSkills.length, userSkills);
            } else {
                console.log('❌ No resume content available - using generic templates');
            }
            
            // Generate personalized content based on tone, focus areas, and resume data
            const intro = generateIntro(position, company, tone);
            const body = generateBody(position, company, jobDescription, keywords, focusAreas, tone, length, relevantExperience, userSkills);
            const closing = generateClosing(tone);
            
            return `${currentDate}

Dear Hiring Manager,

${intro}

${body}

${closing}

Sincerely,
[Your Name]`;
        }
        
        // Extract keywords from job description
        function extractKeywords(description) {
            if (!description) return [];
            
            const commonKeywords = [
                'leadership', 'teamwork', 'communication', 'problem-solving', 'analytical',
                'project management', 'collaboration', 'innovation', 'customer service',
                'technical skills', 'strategic thinking', 'attention to detail', 'adaptability',
                'time management', 'creative', 'results-driven', 'self-motivated'
            ];
            
            const foundKeywords = [];
            commonKeywords.forEach(keyword => {
                if (description.toLowerCase().includes(keyword.toLowerCase())) {
                    foundKeywords.push(keyword);
                }
            });
            
            return foundKeywords.slice(0, 5); // Return top 5 keywords
        }
        
        // Generate introduction paragraph
        function generateIntro(position, company, tone) {
            const templates = {
                professional: `I am writing to express my strong interest in the ${position} position at ${company}. With my proven track record and relevant experience, I am confident that I would be a valuable addition to your team.`,
                enthusiastic: `I was thrilled to discover the ${position} opportunity at ${company}! Your company's reputation for innovation and excellence aligns perfectly with my career aspirations, and I am excited about the possibility of contributing to your continued success.`,
                confident: `As an accomplished professional with extensive experience in my field, I am excited to apply for the ${position} role at ${company}. My proven ability to drive results and exceed expectations makes me an ideal candidate for this position.`,
                conversational: `I hope this letter finds you well. I recently came across the ${position} opening at ${company}, and I couldn't help but feel that this role was written with someone like me in mind. I'd love to tell you why I think I'd be a great fit for your team.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate body paragraphs
        function generateBody(position, company, jobDescription, keywords, focusAreas, tone, length, relevantExperience = [], userSkills = []) {
            let bodyParagraphs = [];
            
            // Experience paragraph - now uses actual resume data
            if (focusAreas.includes('experience')) {
                bodyParagraphs.push(generateExperienceParagraph(tone, keywords, relevantExperience));
            }
            
            // Skills paragraph - now uses actual resume skills
            if (focusAreas.includes('skills')) {
                bodyParagraphs.push(generateSkillsParagraph(tone, keywords, userSkills));
            }
            
            // Passion paragraph
            if (focusAreas.includes('passion')) {
                bodyParagraphs.push(generatePassionParagraph(company, tone));
            }
            
            // Achievements paragraph - enhanced with resume data
            if (focusAreas.includes('achievements')) {
                bodyParagraphs.push(generateAchievementsParagraph(tone, relevantExperience));
            }
            
            // Ensure we have at least one paragraph
            if (bodyParagraphs.length === 0) {
                bodyParagraphs.push(generateExperienceParagraph(tone, keywords, relevantExperience));
            }
            
            // Adjust length based on preference
            if (length === 'concise' && bodyParagraphs.length > 2) {
                bodyParagraphs = bodyParagraphs.slice(0, 2);
            } else if (length === 'detailed' && bodyParagraphs.length < 3) {
                bodyParagraphs.push(generateCompanyParagraph(company, tone));
            }
            
            return bodyParagraphs.join('\n\n');
        }
        
        // Generate experience paragraph
        function generateExperienceParagraph(tone, keywords, relevantExperience = []) {
            // Use actual resume experience if available
            if (relevantExperience.length > 0) {
                const experienceText = relevantExperience.slice(0, 2).join('. ') + '.';
                
                const templates = {
                    professional: `In my professional experience, I have ${experienceText} These accomplishments demonstrate my ability to deliver results and add value to your organization.`,
                    enthusiastic: `I'm excited to share some highlights from my background! ${experienceText} I'm passionate about bringing this same energy and success to your team.`,
                    confident: `My track record includes significant achievements: ${experienceText} I'm confident in my ability to deliver similar results for ${keywords.length > 0 ? keywords[0] : 'your organization'}.`,
                    conversational: `Let me share a bit about what I've accomplished: ${experienceText} I think these experiences would translate really well to this role.`
                };
                
                return templates[tone] || templates.professional;
            }
            
            // Fallback to generic templates if no resume data
            const keywordText = keywords.length > 0 ? ` particularly in ${keywords.slice(0, 2).join(' and ')},` : '';
            
            const templates = {
                professional: `In my previous roles, I have developed strong expertise${keywordText} which directly aligns with the requirements of this position. My experience has taught me the importance of delivering high-quality results while maintaining excellent stakeholder relationships.`,
                enthusiastic: `Throughout my career, I've had the amazing opportunity to develop expertise${keywordText} and I'm genuinely passionate about applying these skills in new and exciting ways. Every project has been a learning experience that has shaped me into the professional I am today.`,
                confident: `My track record speaks for itself. I have consistently delivered exceptional results${keywordText} and have a proven ability to exceed expectations. I thrive in challenging environments and am known for my ability to turn complex problems into innovative solutions.`,
                conversational: `Over the years, I've built up some solid experience${keywordText} and I've learned a lot along the way. I particularly enjoy the problem-solving aspects of my work and find great satisfaction in helping teams achieve their goals.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate skills paragraph
        function generateSkillsParagraph(tone, keywords, userSkills = []) {
            // Use actual resume skills if available, combined with job keywords
            let skillsText = '';
            
            if (userSkills.length > 0) {
                // Combine user skills with relevant job keywords
                const relevantUserSkills = userSkills.filter(skill => 
                    keywords.some(keyword => 
                        skill.toLowerCase().includes(keyword.toLowerCase()) ||
                        keyword.toLowerCase().includes(skill.toLowerCase())
                    )
                );
                
                if (relevantUserSkills.length > 0) {
                    skillsText = relevantUserSkills.slice(0, 3).join(', ');
                } else {
                    // Use top user skills if none match keywords directly
                    skillsText = userSkills.slice(0, 3).join(', ');
                }
            } else {
                // Fallback to job keywords
                skillsText = keywords.length > 0 ? keywords.slice(0, 3).join(', ') : 'technical and soft skills';
            }
            
            const templates = {
                professional: `My skill set encompasses ${skillsText}, which I believe are essential for success in this role. I am committed to continuous learning and staying current with industry best practices to ensure I can contribute effectively from day one.`,
                enthusiastic: `I love bringing my skills in ${skillsText} to every project I work on! I'm always eager to learn new technologies and approaches, and I find that my diverse skill set allows me to contribute in unexpected and valuable ways.`,
                confident: `I excel in ${skillsText} and have a proven track record of leveraging these competencies to drive business results. My ability to quickly master new tools and technologies has been a key factor in my professional success.`,
                conversational: `When it comes to ${skillsText}, I'd say I'm pretty well-rounded. I enjoy the technical challenges of my work, but I also understand that communication and collaboration are just as important as any hard skill.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate passion paragraph
        function generatePassionParagraph(company, tone) {
            const templates = {
                professional: `What particularly attracts me to ${company} is your commitment to excellence and innovation. I am excited about the opportunity to contribute to an organization that shares my values and dedication to making a meaningful impact.`,
                enthusiastic: `I have to say, I'm genuinely excited about ${company} and what you're doing in the industry! Your mission really resonates with me, and I would love nothing more than to be part of a team that's making such a positive difference.`,
                confident: `${company} represents exactly the kind of forward-thinking organization where I know I can make a significant impact. Your reputation for excellence aligns perfectly with my own standards and professional aspirations.`,
                conversational: `I've been following ${company} for a while now, and I really admire what you're doing. It seems like a place where I could not only contribute my skills but also continue to grow and learn from some really talented people.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate achievements paragraph
        function generateAchievementsParagraph(tone, relevantExperience = []) {
            // Use actual achievements from resume if available
            if (relevantExperience.length > 0) {
                const achievementExample = relevantExperience.find(exp => 
                    exp.toLowerCase().includes('led') || 
                    exp.toLowerCase().includes('managed') ||
                    exp.toLowerCase().includes('increased') ||
                    exp.toLowerCase().includes('improved') ||
                    exp.toLowerCase().includes('developed')
                ) || relevantExperience[0];
                
                const templates = {
                    professional: `I am particularly proud of achievements such as: ${achievementExample}. This experience demonstrates my ability to deliver measurable results and contribute meaningfully to organizational objectives.`,
                    enthusiastic: `One achievement I'm really excited to share is: ${achievementExample}! This kind of hands-on experience has taught me so much about what it takes to succeed in challenging environments.`,
                    confident: `Among my key accomplishments: ${achievementExample}. This achievement exemplifies my ability to drive results and exceed expectations in demanding professional settings.`,
                    conversational: `Here's something I'm proud of: ${achievementExample}. Experiences like this have really shaped how I approach new challenges and work with teams.`
                };
                
                return templates[tone] || templates.professional;
            }
            
            // Fallback to generic achievements
            const templates = {
                professional: `In my recent role, I successfully led initiatives that resulted in measurable improvements in efficiency and performance. I am particularly proud of my ability to build consensus among diverse stakeholders and deliver projects on time and within budget.`,
                enthusiastic: `I'm really proud of some of the achievements I've accomplished in my career! From leading successful projects to mentoring team members, I've learned that the best results come from collaboration and a genuine commitment to excellence.`,
                confident: `My achievements speak for themselves. I have consistently delivered results that exceed expectations, including leading high-impact projects that have generated significant value for my organizations. I bring this same level of excellence to everything I do.`,
                conversational: `I've been fortunate to work on some really interesting projects over the years. Whether it's streamlining processes or helping team members develop their skills, I find the most rewarding work comes from making things better for everyone involved.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate company-specific paragraph
        function generateCompanyParagraph(company, tone) {
            const templates = {
                professional: `I have researched ${company} extensively and am impressed by your commitment to innovation and customer satisfaction. I believe my background and experience would enable me to contribute meaningfully to your continued success.`,
                enthusiastic: `Everything I've learned about ${company} has only increased my excitement about this opportunity! From your company culture to your innovative approach to business, it's clear that this is where I want to build my career.`,
                confident: `${company} is clearly a leader in the industry, and I am confident that my expertise and drive would be valuable assets to your organization. I am ready to hit the ground running and make an immediate impact.`,
                conversational: `From what I've seen, ${company} seems like the kind of place where I could really thrive. I appreciate companies that value both results and relationships, and I think that's exactly what you've built there.`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Generate closing paragraph
        function generateClosing(tone) {
            const templates = {
                professional: `I would welcome the opportunity to discuss how my background and enthusiasm can contribute to your team's success. Thank you for considering my application, and I look forward to hearing from you soon.`,
                enthusiastic: `I would absolutely love the chance to discuss this opportunity with you further! Thank you so much for your time and consideration – I'm really hoping we can connect soon to talk about how I can contribute to your amazing team.`,
                confident: `I am confident that I would be a valuable addition to your team and would welcome the opportunity to discuss this role in detail. I look forward to demonstrating how I can contribute to your organization's continued success.`,
                conversational: `I'd really enjoy the chance to chat with you about this role and learn more about your team. Thanks for taking the time to consider my application – I hope we can connect soon!`
            };
            
            return templates[tone] || templates.professional;
        }
        
        // Display the generated cover letter
        function displayCoverLetter(coverLetter, jobData = null) {
            currentCoverLetter = coverLetter;
            
            const output = document.getElementById('cover-letter-output');
            const actions = document.getElementById('cover-letter-actions');
            const analysis = document.getElementById('cover-letter-analysis');
            
            // Format the cover letter with proper line breaks
            const formattedLetter = coverLetter.replace(/\n/g, '<br>');
            output.innerHTML = `<div class="whitespace-pre-wrap font-serif leading-relaxed">${formattedLetter}</div>`;
            
            // Show action buttons
            actions.classList.remove('hidden');
            
            // Generate and show analysis
            const analysisData = analyzeCoverLetter(coverLetter, jobData);
            updateAnalysisDisplay(analysisData);
            analysis.classList.remove('hidden');
        }
        
        // Analyze cover letter content
        function analyzeCoverLetter(content) {
            const words = content.split(/\s+/).filter(word => word.length > 0);
            const sentences = content.split(/[.!?]+/).filter(sentence => sentence.trim().length > 0);
            
            // Calculate readability (simplified Flesch Reading Ease)
            const avgWordsPerSentence = words.length / sentences.length;
            const readabilityScore = Math.max(0, Math.min(100, 206.835 - (1.015 * avgWordsPerSentence)));
            
            let readabilityLevel = 'Very Difficult';
            if (readabilityScore > 90) readabilityLevel = 'Very Easy';
            else if (readabilityScore > 80) readabilityLevel = 'Easy';
            else if (readabilityScore > 70) readabilityLevel = 'Fairly Easy';
            else if (readabilityScore > 60) readabilityLevel = 'Standard';
            else if (readabilityScore > 50) readabilityLevel = 'Fairly Difficult';
            else if (readabilityScore > 30) readabilityLevel = 'Difficult';
            
            // Count keywords (simplified) - get from current form
            const jobDescription = document.getElementById('cover-job-description')?.value || '';
            const jobKeywords = jobDescription ? extractKeywords(jobDescription).length : 0;
            
            // Check if resume data was used
            const resumeContent = getCoverLetterResumeContent();
            const usedResumeData = resumeContent ? 'Yes' : 'No';
            
            // Tone analysis (simplified)
            const toneWords = {
                enthusiastic: ['excited', 'thrilled', 'passionate', 'love', 'amazing'],
                confident: ['proven', 'excel', 'accomplished', 'expertise', 'confident'],
                professional: ['experience', 'skills', 'qualifications', 'background', 'professional']
            };
            
            let dominantTone = 'Balanced';
            let maxScore = 0;
            
            Object.keys(toneWords).forEach(tone => {
                const score = toneWords[tone].reduce((count, word) => {
                    return count + (content.toLowerCase().includes(word) ? 1 : 0);
                }, 0);
                
                if (score > maxScore) {
                    maxScore = score;
                    dominantTone = tone.charAt(0).toUpperCase() + tone.slice(1);
                }
            });
            
            return {
                wordCount: words.length,
                readability: readabilityLevel,
                keywordsMatched: jobKeywords,
                toneScore: dominantTone,
                resumeDataUsed: usedResumeData
            };
        }
        
        // Update analysis display
        function updateAnalysisDisplay(analysis) {
            document.getElementById('analysis-word-count').textContent = analysis.wordCount;
            document.getElementById('analysis-readability').textContent = analysis.readability;
            document.getElementById('analysis-keywords').textContent = analysis.keywordsMatched + ' matched';
            document.getElementById('analysis-resume-data').textContent = analysis.resumeDataUsed;
            
            // Update resume data indicator color based on whether data was used
            const resumeDataElement = document.getElementById('analysis-resume-data');
            if (analysis.resumeDataUsed === 'Yes') {
                resumeDataElement.className = 'text-green-600';
            } else {
                resumeDataElement.className = 'text-orange-600';
            }
        }
        
        // Enter edit mode
        function enterEditMode() {
            const output = document.getElementById('cover-letter-output');
            const editMode = document.getElementById('cover-letter-edit-mode');
            const editor = document.getElementById('cover-letter-editor');
            const actions = document.getElementById('cover-letter-actions');
            
            // Switch to edit mode
            output.classList.add('hidden');
            editMode.classList.remove('hidden');
            actions.classList.add('hidden');
            
            // Populate editor with current content
            editor.value = currentCoverLetter;
            editor.focus();
        }
        
        // Cancel edit mode
        function cancelEditMode() {
            const output = document.getElementById('cover-letter-output');
            const editMode = document.getElementById('cover-letter-edit-mode');
            const actions = document.getElementById('cover-letter-actions');
            
            // Switch back to view mode
            output.classList.remove('hidden');
            editMode.classList.add('hidden');
            actions.classList.remove('hidden');
        }
        
        // Save edit changes
        function saveEditChanges() {
            const editor = document.getElementById('cover-letter-editor');
            const newContent = editor.value;
            
            if (newContent.trim()) {
                currentCoverLetter = newContent;
                displayCoverLetter(newContent);
                cancelEditMode();
                showToast('Cover letter updated successfully!', 'success');
            } else {
                showToast('Cover letter cannot be empty', 'error');
            }
        }
        
        // Copy cover letter to clipboard
        async function copyCoverLetter() {
            try {
                await navigator.clipboard.writeText(currentCoverLetter);
                showToast('Cover letter copied to clipboard!', 'success');
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentCoverLetter;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showToast('Cover letter copied to clipboard!', 'success');
            }
        }
        
        // Download cover letter as PDF
        function downloadCoverLetter() {
            if (!currentCoverLetter) {
                showToast('No cover letter to download', 'error');
                return;
            }
            
            // Get job details from form
            const jobTitle = document.getElementById('cover-job-title')?.value || 'Position';
            const companyName = document.getElementById('cover-company-name')?.value || 'Company';
            
            try {
                // Create PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up document properties
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                
                // Add title
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Cover Letter', margin, 30);
                
                // Add job information
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Position: ${jobTitle}`, margin, 45);
                doc.text(`Company: ${companyName}`, margin, 55);
                
                // Add cover letter content
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(currentCoverLetter, maxWidth);
                doc.text(lines, margin, 75);
                
                // Save the document
                const fileName = `Cover_Letter_${companyName}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('Cover letter downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Failed to download PDF. Please try again.', 'error');
            }
        }
    
    // Make Cover Letter functions globally accessible for debugging
    window.testCoverLetterButton = function() {
        console.log('🧪 Testing Cover Letter button...');
        const button = document.getElementById('generate-cover-letter-btn');
        if (button) {
            console.log('✅ Button found');
            button.click();
        } else {
            console.error('❌ Button not found');
        }
    };
    
    window.debugCoverLetter = function() {
        console.log('🔍 Cover Letter Debug Info:');
        console.log('- Generate Button:', !!document.getElementById('generate-cover-letter-btn'));
        console.log('- Job Select:', !!document.getElementById('cover-letter-job-select'));
        console.log('- Current Job:', currentJobForCoverLetter);
        console.log('- All Jobs:', allJobs.length);
        console.log('- Extracted Resume Text:', !!extractedResumeText);
        console.log('- Resume Text Length:', extractedResumeText ? extractedResumeText.length : 0);
        console.log('- Text Input Element:', !!document.getElementById('current-resume-input'));
        console.log('- Text Input Content:', document.getElementById('current-resume-input')?.value?.length || 0);
        console.log('- getCurrentResumeContent():', !!getCurrentResumeContent());
    };
    
    window.testResumeData = function() {
        console.log('🧪 Testing Resume Data Access:');
        const content = getCurrentResumeContent();
        if (content) {
            console.log('✅ Resume content found:', content.length, 'characters');
            console.log('📄 Preview:', content.substring(0, 300));
            const skills = extractSkillsFromResume(content);
            const experience = extractRelevantExperience(content, ['python', 'data', 'machine learning']);
            console.log('🛠️ Extracted skills:', skills);
            console.log('📋 Extracted experience:', experience);
        } else {
            console.log('❌ No resume content available');
        }
    };
    
    // Make Cover Letter functions globally accessible
    window.clearCoverUploadedFile = clearCoverUploadedFile;
    
    // Make functions globally accessible for debugging
    window.clearUploadedFile = clearUploadedFile;
    window.downloadAsPDF = downloadAsPDF;
    window.downloadAsText = downloadAsText;
    window.closeDownloadModal = closeDownloadModal;
    window.showDownloadModal = showDownloadModal;
    
    initializeFirebase();
    initializeSmartResume();
    initializeInterviewPrep();
    initializeCoverLetter();
    switchTab(document.querySelector('.nav-tab[data-tab="dashboard"]'));
    
    // Test download button connection
    setTimeout(() => {
        const downloadBtn = document.getElementById('download-resume-btn');
        if (downloadBtn) {
            console.log('Download button found and connected');
        } else {
            console.error('Download button not found!');
        }
    }, 1000);

    // Add debug test function to global scope for console testing
    window.testResumeParsing = function() {
        const testResume = `IBRAHIM LAHAI
18 Hennessy Street, Kingtom, Freetown, Sierra Leone
+232 78 377 336 / +232 31 077 461 | lahaiibrahim@gmail.com
Professional Summary
A detail-oriented and experienced accounting professional with a Bachelor of Science in Applied
Accounting and a strong background in finance and administration.
Experience
Finance and Admin Officer | Kubia Business Enterprises Ltd
Freetown | January 2019 – Present
● Prepare and process accounts payable and receivable.
● Manage staff payroll, ensuring accurate and timely processing.
Technical Skills
● QuickBooks Pro
● MS Excel
● MS Word`;
        
        console.log('🧪 TESTING RESUME PARSING:');
        console.log('🧪 Test resume length:', testResume.length);
        
        const name = extractNameFromResume(testResume);
        console.log('🧪 Extracted name:', name);
        
        const skills = extractSkillsFromResume(testResume);
        console.log('🧪 Extracted skills:', skills);
        
        const experience = extractRelevantExperience(testResume, ['accounting', 'payroll']);
        console.log('🧪 Extracted experience:', experience);
        
        return { name, skills, experience };
    };

    });
</script>
</body>
</html>

